<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amber Compare & Export</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .calendar-day {
            min-height: 85px;
            transition: background-color 0.2s;
        }
        .calendar-day.has-data {
             cursor: pointer;
        }
        #day-tooltip {
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .day-checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .day-checkbox-label input:checked + span {
             font-weight: bold;
             color: #1a56db; /* A blue color */
        }
        .day-checkbox-label:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        <header class="bg-white rounded-lg shadow-md p-6 mb-6 relative">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center">
                        <img src="favicon.ico" alt="Favicon Image" class="mr-4 h-14 w-14"> Amber Compare & Export
                    </h1>
                    <p class="mt-2 text-gray-600">Enter your Amber API key and select a date range to compare costs or export your usage data.</p>
                </div>
                <div class="relative">
                    <button id="settingsBtn" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                    </button>
                    <div id="settingsMenu" class="hidden absolute right-0 mt-2 w-60 bg-white rounded-md shadow-lg py-1 z-20 border border-gray-200">
                        <!-- Content will be moved here -->
                    </div>
                </div>
            </div>
        </header>

        <main>
            <div id="configSection" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center cursor-pointer" id="configHeader">
                    <div id="configHeaderLeftGroup" class="flex items-center gap-4">
                        <h2 class="text-lg font-bold text-gray-900">Configuration</h2>
                    </div>
                    <button id="toggleConfigBtn" class="flex items-center text-indigo-600 hover:underline focus:outline-none font-medium">
                        <span class="mr-1">Hide</span>
                        <svg id="configChevron" class="w-5 h-5 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                </div>
                
                <div id="configContent" class="mt-4 pt-4 border-t">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2">
                            <label for="apiKey" class="block text-sm font-medium text-gray-700 mb-1">Amber API Key</label>
                            <input type="password" id="apiKey" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="psk_...">
                            <p class="text-xs text-gray-500 mt-1">Your key is stored only in your browser. Find it at <a href="https://app.amber.com.au/developers" target="_blank" class="text-indigo-600 hover:underline">app.amber.com.au/developers</a>.</p>
                        </div>

                         <div class="md:col-span-2 border-t pt-4">
                             <h3 id="otherSupplierHeading" class="block text-base font-medium text-gray-800 mb-2">Other Supplier Details</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="stateSelector" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                                    <select id="stateSelector" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                                </div>
                                <div id="planSelectorContainer">
                                    <label id="planSelectorLabel" for="planSelector" class="block text-sm font-medium text-gray-700 mb-1">Supplier Plan</label>
                                    <select id="planSelector" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="">-- Custom --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <label for="planName" class="block text-sm font-medium text-gray-700 mb-1">Plan Name</label>
                                <input type="text" id="planName" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., Energy Australia TOU 2025">
                            </div>

                             <div class="my-4 pt-4 border-t">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Rate Structure</label>
                                <div class="flex items-center space-x-4" id="rateTypeSelector">
                                    <label class="flex items-center">
                                        <input type="radio" name="rateType" value="flat" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300" checked>
                                        <span class="ml-2 text-sm text-gray-700">Flat Rate</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="radio" name="rateType" value="tou" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300">
                                        <span class="ml-2 text-sm text-gray-700">Time of Use (TOU)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <label for="dailyConnectionRate" class="block text-sm font-medium text-gray-700 mb-1">Daily Connection (c/day)</label>
                                <input type="number" id="dailyConnectionRate" value="102.83" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                <p class="text-xs text-gray-500 mt-1">This is a fixed daily service fee.</p>
                            </div>

                            <div id="flatRateSection" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                 <div>
                                    <label for="otherSupplierRate" class="block text-sm font-medium text-gray-700 mb-1">General Rate (c/kWh)</label>
                                    <input type="number" id="otherSupplierRate" value="36" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 36">
                                 </div>
                                 <div>
                                    <label for="otherSupplierFeedInRateFlat" class="block text-sm font-medium text-gray-700 mb-1">Feed-in Rate (c/kWh)</label>
                                    <input type="number" id="otherSupplierFeedInRateFlat" value="5" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 5">
                                </div>
                            </div>

                            <div id="touRateSection" class="hidden">
                                <h3 class="text-md font-medium text-gray-800 mt-4 pt-4 border-t border-gray-200 mb-2">Consumption Rates & Times</h3>
                                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                                    <!-- Peak -->
                                    <div class="bg-red-50 p-3 rounded-lg border border-red-200" data-tou-period="peak">
                                        <label for="tou_peak_rate" class="block text-sm font-medium text-red-700">Peak Rate (c/kWh)</label>
                                        <input type="number" id="tou_peak_rate" value="57.93" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <div><label class="text-xs font-medium text-gray-600" for="tou_peak_start">Start</label><input type="time" id="tou_peak_start" value="14:00" class="w-full text-sm p-1 border border-gray-300 rounded"></div>
                                            <div><label class="text-xs font-medium text-gray-600" for="tou_peak_end">End</label><input type="time" id="tou_peak_end" value="20:00" class="w-full text-sm p-1 border border-gray-300 rounded"></div>
                                        </div>
                                        <div class="mt-2 text-xs font-medium text-gray-600">Days:</div>
                                        <div class="grid grid-cols-4 gap-x-2 gap-y-1 mt-1 text-xs">
                                            <label class="day-checkbox-label"><input type="checkbox" value="1"><span>Mon</span></label> <label class="day-checkbox-label"><input type="checkbox" value="2"><span>Tue</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="3"><span>Wed</span></label> <label class="day-checkbox-label"><input type="checkbox" value="4"><span>Thu</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="5"><span>Fri</span></label> <label class="day-checkbox-label"><input type="checkbox" value="6"><span>Sat</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="0"><span>Sun</span></label>
                                        </div>
                                    </div>
                                    <!-- Shoulder -->
                                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200" data-tou-period="shoulder">
                                        <label for="tou_shoulder_rate" class="block text-sm font-medium text-yellow-700">Shoulder Rate (c/kWh)</label>
                                        <input type="number" id="tou_shoulder_rate" value="30.61" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <div><label class="text-xs font-medium text-gray-600" for="tou_shoulder_start">Start</label><input type="time" id="tou_shoulder_start" value="07:00" class="w-full text-sm p-1 border border-gray-300 rounded"></div>
                                            <div><label class="text-xs font-medium text-gray-600" for="tou_shoulder_end">End</label><input type="time" id="tou_shoulder_end" value="14:00" class="w-full text-sm p-1 border border-gray-300 rounded"></div>
                                        </div>
                                        <div class="mt-2 text-xs font-medium text-gray-600">Days:</div>
                                        <div class="grid grid-cols-4 gap-x-2 gap-y-1 mt-1 text-xs">
                                            <label class="day-checkbox-label"><input type="checkbox" value="1"><span>Mon</span></label> <label class="day-checkbox-label"><input type="checkbox" value="2"><span>Tue</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="3"><span>Wed</span></label> <label class="day-checkbox-label"><input type="checkbox" value="4"><span>Thu</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="5"><span>Fri</span></label> <label class="day-checkbox-label"><input type="checkbox" value="6"><span>Sat</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="0"><span>Sun</span></label>
                                        </div>
                                    </div>
                                    <!-- Off-Peak -->
                                    <div class="bg-green-50 p-3 rounded-lg border border-green-200" data-tou-period="offpeak">
                                        <label for="tou_offpeak_rate" class="block text-sm font-medium text-green-700">Off-Peak Rate (c/kWh)</label>
                                        <input type="number" id="tou_offpeak_rate" value="24.28" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                        <!-- Time and day inputs removed as Off-Peak is now the default catch-all -->
                                        <input type="hidden" id="tou_offpeak_start">
                                        <input type="hidden" id="tou_offpeak_end">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                     <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <label for="tou_controlled_load_rate" class="block text-sm font-medium text-blue-700">Controlled Load (c/kWh)</label>
                                        <p class="text-xs text-gray-500">Applies 24/7 to the controlled load channel.</p>
                                        <input type="number" id="tou_controlled_load_rate" value="14.6" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                        <label for="otherSupplierFeedInRateTou" class="block text-sm font-medium text-gray-700">Feed-in Rate (c/kWh)</label>
                                        <p class="text-xs text-gray-500">Applies 24/7 to the feed-in channel.</p>
                                        <input type="number" id="otherSupplierFeedInRateTou" value="4.0" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="e.g., 5">
                                    </div>
                                </div>
                            </div>

                             <div id="demandTariffSection" class="mt-4 pt-4 border-t">
                                <div class="flex items-center mb-2">
                                    <input type="checkbox" id="enableDemandTariff" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                                    <label for="enableDemandTariff" class="ml-2 block text-sm font-medium text-gray-800">Enable Demand Tariff for Other Supplier</label>
                                </div>
                                <div id="demandTariffInputs" class="hidden grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div>
                                        <label for="demandRate" class="block text-sm font-medium text-gray-700">Demand Rate (c/kW/day)</label>
                                        <input type="number" id="demandRate" value="30" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label for="demandWindowStart" class="block text-sm font-medium text-gray-700">Window Start</label>
                                        <input type="time" id="demandWindowStart" value="16:00" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div>
                                        <label for="demandWindowEnd" class="block text-sm font-medium text-gray-700">Window End</label>
                                        <input type="time" id="demandWindowEnd" value="21:00" class="w-full mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                                    </div>
                                    <div class="sm:col-span-3 mt-1">
                                        <label class="text-sm font-medium text-gray-700">Applicable Days</label>
                                        <div class="flex flex-wrap gap-x-4 gap-y-1 mt-1 text-sm" id="demandDaysContainer">
                                            <label class="day-checkbox-label"><input type="checkbox" value="1"><span>Mon</span></label> <label class="day-checkbox-label"><input type="checkbox" value="2"><span>Tue</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="3"><span>Wed</span></label> <label class="day-checkbox-label"><input type="checkbox" value="4"><span>Thu</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="5"><span>Fri</span></label> <label class="day-checkbox-label"><input type="checkbox" value="6"><span>Sat</span></label>
                                            <label class="day-checkbox-label"><input type="checkbox" value="0"><span>Sun</span></label>
                                        </div>
                                    </div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Calculates a charge on your highest 30-min usage during the daily window across the entire period.</p>
                            </div>
                        </div>
                    </div>
                </div>
             

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-t pt-4 mt-4">
                     <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="startDate" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                     <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="endDate" class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>


                 <div class="mt-6 text-right">
                    <button id="fetchData" title="Compare Amber to your chosen competitor. Reports/Graphs/Calendar." class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Compare Costs
                    </button>
                </div>
                
                               
                   
 
             
                                </div>
                                
               <div id="messageContainer" class="hidden text-center mt-6 mb-4 p-4 border rounded-lg bg-gray-50">
                    <p id="message" class="text-lg"></p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                        <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                </div>                                
                                
                                
                                
                                
                                
            </div>

            <div id="resultsSection" class="hidden">
                 <div id="results-output" class="bg-white rounded-lg shadow-md p-6 overflow-x-auto mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Comparison Results</h2>
                        <div class="flex items-center">
                            <div class="flex items-center space-x-2 mr-4">
                                <span class="text-sm font-medium text-gray-700">GST</span>
                                <label for="gstToggle" class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="gstToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="relative">
                                <button id="downloadCsvButton" title="Export data options" disabled class="p-2 rounded-full text-gray-500 hover:bg-gray-100 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                                </button>
                                <div id="csvDropdownMenu" class="hidden absolute right-0 mt-2 w-max bg-white rounded-md shadow-lg py-1 z-20 border border-gray-200">
                                    <a href="#" id="downloadFullIntervalCsv" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Export Full Data</a>
                                    <a href="#" id="downloadDailySummaryCsv" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Export Daily Summaries</a>
                                    <a href="#" id="downloadResultsTableCsv" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Export Results Table</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="results-table-container"></div>
                 </div>

                 <div id="averageGraphContainer" class="hidden bg-white rounded-lg shadow-md p-6 mb-6 h-[80vh]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-900">Average 24-Hour Usage & Price</h3>
                        <button id="resetAverageZoomBtn" class="hidden bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">↔️</button>
                    </div>
                    <div class="h-[70vh] relative">
                        <canvas id="usagePriceChart"></canvas>
                    </div>
                </div>

                <div id="dailyGraphSection" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">

                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl sm:text-2xl font-bold text-gray-900">Daily Usage & Price Graph</h3>
                    <div class="flex items-center space-x-2 sm:space-x-4">
                        <button id="prevDayBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 font-semibold">&lt;</button>
                        <select id="daySelector" class="w-full max-w-xs px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></select>
                        <button id="nextDayBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 font-semibold">&gt;</button>
                        <button id="resetDailyZoomBtn" class="hidden bg-gray-200 text-gray-800 font-semibold py-1 px-3 rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">↔️</button>
                    </div>
                </div>
            
                <div class="h-[70vh] relative">
                    <canvas id="dailyChart"></canvas>
                </div>
            
            </div>
            </div>
            
            <div id="calendarSection" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
                 <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Daily Summary Calendar</h2>
                 </div>
 
                <div id="calendar-container" class="space-y-6">
                    <!-- Monthly calendars will be dynamically inserted here -->
                </div>
                
                <div class="mt-4 pt-4 border-t text-center">
                    <p id="cacheMessage" class="text-sm mt-2 font-medium"></p>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Amber Electric Constants (Refactored) ---
        const AMBER_CONNECTION_COST_PER_DAY_CENTS = 109.894;
        const AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS = 82.203;
        const AMBER_DEMAND_TARIFF_COST_PER_KW_CENTS = 42.345;
        const AMBER_API_URL = 'https://api.amber.com.au/v1';

        // --- Global cache for API data ---
        let cachedChannelData = null;
        let cachedAllChannelData = null;
        let dailySummaries = {};
        let demandInfoForTooltip = null;
        let lastFetchedStartDate = null;
        let lastFetchedEndDate = null;
        let lastFetchTimestamp = null;
        let usageChart = null;
        let dailyUsageChart = null;
        let currentSiteId = null;
        let lastResultDataPayload = null;
        let amberCostBaseline = null;

        function adjustForGst(cost, isFeedIn = false) {
            const gstToggle = document.getElementById('gstToggle');
            if (!gstToggle.checked && !isFeedIn) {
                return cost / 1.1;
            }
            return cost;
        }

        // --- Supplier Templates ---
        const supplierTemplates = {
            "ACT": {
                "ActewAGL - Standard Home": {
                    rateType: 'flat', daily: 196.35, flat: 39.04, feedIn: 8.0, cl: 17.28,
                    demand: { e: false }
                },
                "ActewAGL - TOU": {
                    rateType: 'tou', daily: 196.35, feedIn: 8.0, cl: 17.28,
                    tou: {
                        peak: { rate: 48.23, start: '17:00', end: '20:00', days: [1, 2, 3, 4, 5] },
                        shoulder: { rate: 43.89, start: '07:00', end: '17:00', days: [1, 2, 3, 4, 5] },
                        offpeak: { rate: 33.24 }
                    },
                    demand: { e: false }
                }
            },
            "NSW": {
                "EnergyAustralia - Total Plan": {
                    rateType: 'tou', daily: 121.58, feedIn: 7.6, cl: 17.88,
                    tou: {
                        peak: { rate: 51.55, start: '14:00', end: '20:00', days: [1, 2, 3, 4, 5] },
                        shoulder: { rate: 27.24, start: '07:00', end: '14:00', days: [1, 2, 3, 4, 5] },
                        offpeak: { rate: 20.35 }
                    },
                    demand: { e: true, r: 33.55, s: '17:00', f: '20:00', days: [1,2,3,4,5] }
                },
                "EnergyAustralia - Solar Max": {"rateType":"flat","daily":109.12,"flat":40.172,"feedIn":8,"demand":{"e":false,"r":0,"s":"16:00","f":"21:00","days":[]}},
                "AGL - Standard": { rateType: 'flat', daily: 102.8, flat: 36.5, feedIn: 5.0, demand: { e: false } },
                "Origin - Go Variable": {
                    rateType: 'tou', daily: 110.0, feedIn: 6.0, cl: 18.0,
                    tou: {
                        peak: { rate: 55.2, start: '14:00', end: '20:00', days: [1,2,3,4,5]},
                        shoulder: {rate: 30.1, start: '07:00', end: '14:00', days: [1,2,3,4,5]},
                        offpeak: {rate: 22.5}
                    },
                     demand: { e: false }
                },
                "Red Energy - Living Energy Saver": {
                    rateType: 'flat', daily: 105.0, flat: 34.2, feedIn: 6.0, cl: 16.5,
                    demand: { e: false }
                },
                "Alinta Energy - Homesaver": {
                    rateType: 'flat', daily: 112.0, flat: 35.8, feedIn: 5.2, cl: 17.0,
                    demand: { e: false }
                },
                "Greg Flat...": {"rateType":"tou","daily":102.2,"feedIn":4,"cl":19.5,"tou":{"peak":{"rate":34.2,"start":"00:00","end":"00:00","days":[1,2,3,4,5,6,0]},"shoulder":{"rate":34.2,"start":"00:00","end":"00:00","days":[1,2,3,5,6,0]},"offpeak":{"rate":34.2}},"demand":{"e":false,"r":0,"s":"16:00","f":"21:00","days":[]}},
                "Greg TOU...": {"rateType":"tou","daily":102.2,"feedIn":4,"cl":16.24,"tou":{"peak":{"rate":40.44,"start":"16:00","end":"20:00","days":[1,2,3,4,5,6,0]},"shoulder":{"rate":26.73,"start":"10:00","end":"14:00","days":[1,2,3,4,5,6,0]},"offpeak":{"rate":33.72}},"demand":{"e":false,"r":0,"s":"16:00","f":"21:00","days":[]}}
            },
            "NT": {
                "Jacana Energy - Standard": {
                    rateType: 'flat', daily: 150.0, flat: 28.5, feedIn: 9.33, cl: 18.0,
                    demand: { e: false }
                }
            },
            "QLD": {
                 "EnergyAustralia - Basic Home": {
                    rateType: 'tou', daily: 130.1, feedIn: 5.0, cl: 18.2,
                    tou: {
                        peak: { rate: 44.5, start: '16:00', end: '21:00', days: [1,2,3,4,5] },
                        shoulder: { rate: 24.3, start: '07:00', end: '16:00', days: [1,2,3,4,5] },
                        offpeak: { rate: 19.8 }
                    },
                    demand: { e: true, r: 35.1, s: '16:00', f: '21:00', days: [1,2,3,4,5] }
                },
                "AGL - Standard": { rateType: 'flat', daily: 125.6, flat: 28.9, feedIn: 5.0, demand: { e: false } },
                "Origin - Basic": { rateType: 'flat', daily: 128.0, flat: 29.5, feedIn: 5.0, cl: 19.0, demand: { e: false } },
                 "Red Energy - QLD Saver": {
                    rateType: 'flat', daily: 132.5, flat: 30.1, feedIn: 6.0, cl: 20.2,
                    demand: { e: false }
                }
            },
            "SA": {
                "EnergyAustralia - Total Plan": {
                    rateType: 'tou', daily: 145.2, feedIn: 6.0, cl: 22.1,
                    tou: {
                        peak: { rate: 60.1, start: '18:00', end: '21:00', days: [1,2,3,4,5] },
                        shoulder: { rate: 40.5, start: '07:00', end: '18:00', days: [1,2,3,4,5] },
                        offpeak: { rate: 30.2 }
                    },
                    demand: { e: true, r: 40.2, s: '18:00', f: '21:00', days: [1,2,3,4,5] }
                },
                "AGL - Standard": { rateType: 'flat', daily: 138.0, flat: 42.3, feedIn: 6.0, demand: { e: false } },
                "Origin - Value": { rateType: 'flat', daily: 140.0, flat: 43.5, feedIn: 7.0, cl: 23.0, demand: { e: false } },
                "Alinta - Homesaver SA": { rateType: 'flat', daily: 135.5, flat: 41.8, feedIn: 6.5, cl: 21.5, demand: { e: false }}
            },
            "TAS": {
                "Aurora Energy - Residential Peak and Off-Peak": {
                    rateType: 'tou', daily: 126.39, feedIn: 10.8, cl: 19.45,
                    tou: {
                        peak: { rate: 36.20, start: '07:00', end: '21:00', days: [1,2,3,4,5,6,0] }, // Note: Aurora has a complex structure, this is a simplified model. Peak is 7am-10am and 4pm-9pm weekdays. Rest is offpeak.
                        shoulder: { rate: 16.86, start: '10:00', end: '16:00', days: [1,2,3,4,5,6,0] },
                        offpeak: { rate: 16.86 }
                    },
                    demand: { e: false }
                },
                 "Aurora Energy - Standard Residential": {
                    rateType: 'flat', daily: 113.77, flat: 29.95, feedIn: 10.8, cl: 19.45,
                    demand: { e: false }
                },
                "1st Energy - Standing Offer": {
                    rateType: 'flat', daily: 113.77, flat: 29.95, feedIn: 9.0, cl: 19.45,
                    demand: { e: false }
                }
            },
            "VIC": {
                "EnergyAustralia - Flexi Plan": {
                    rateType: 'tou', daily: 115.3, feedIn: 4.9, cl: 20.1,
                    tou: {
                        peak: { rate: 48.9, start: '15:00', end: '21:00', days: [1,2,3,4,5,6,0] },
                        shoulder: { rate: 33.1, start: '07:00', end: '15:00', days: [1,2,3,4,5,6,0] },
                        offpeak: { rate: 24.6 }
                    },
                    demand: { e: true, r: 29.8, s: '15:00', f: '21:00', days: [1,2,3,4,5] }
                },
                "AGL - Victorian Default Offer": { rateType: 'flat', daily: 120.0, flat: 31.5, feedIn: 4.9, demand: { e: false } },
                "Red Energy - Red EV Saver": {
                     rateType: 'tou', daily: 118.0, feedIn: 5.2, cl: 21.0,
                     tou: {
                        peak: { rate: 47.5, start: '15:00', end: '21:00', days: [1,2,3,4,5,6,0] },
                        shoulder: { rate: 32.0, start: '07:00', end: '15:00', days: [1,2,3,4,5,6,0]},
                        offpeak: { rate: 23.8 }
                     },
                     demand: { e: false }
                },
                "Origin - Basic VIC": { rateType: 'flat', daily: 122.3, flat: 32.1, feedIn: 4.9, cl: 20.5, demand: { e: false } },
            },
            "WA": {
                 "Synergy - Home Plan (A1)": {
                    rateType: 'flat', daily: 116.05, flat: 32.37, feedIn: 10.0, // Feed-in varies, 10c is for peak times.
                    demand: { e: false }
                },
                 "Synergy - Smart Home Plan": {
                    rateType: 'tou', daily: 116.05, feedIn: 10.0,
                    tou: {
                        peak: { rate: 61.56, start: '15:00', end: '21:00', days: [1,2,3,4,5,6,0] },
                        shoulder: { rate: 32.24, start: '07:00', end: '15:00', days: [1,2,3,4,5] },
                        offpeak: { rate: 16.96 }
                    },
                    demand: { e: false }
                }
            }
        };

        const originalSupplierTemplates = JSON.parse(JSON.stringify(supplierTemplates));


        // --- IndexedDB Helper Functions ---
        const DB_NAME = 'AmberDataCacheDB';
        const STORE_NAME = 'dailyUsage';
        const DB_VERSION = 1;

        function openDb() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.errorCode);
                    reject(event.target.error);
                };
            });
        }

        function getUsageData(db, id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);

                request.onsuccess = (event) => {
                    resolve(event.target.result ? event.target.result.data : null);
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        function setUsageData(db, id, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put({ id, data });

                request.onsuccess = () => {
                    resolve();
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        function getAllCachedDates(db, siteId) {
            return new Promise((resolve, reject) => {
                if (!siteId) {
                    resolve([]);
                    return;
                }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAllKeys();

                request.onsuccess = (event) => {
                    const keys = event.target.result;
                    const dates = keys
                        .filter(key => key.startsWith(`${siteId}_`))
                        .map(key => key.substring(siteId.length + 1));
                    resolve(dates);
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }


        const formatForInput = (date) => {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function toLocalIsoWithOffset(d) {
            function pad(n) { return String(n).padStart(2, '0'); }
            const year = d.getFullYear();
            const month = pad(d.getMonth() + 1);
            const day = pad(d.getDate());
            const hours = pad(d.getHours());
            const minutes = pad(d.getMinutes());
            const seconds = pad(d.getSeconds());

            const offsetMinutes = -d.getTimezoneOffset();
            const sign = offsetMinutes >= 0 ? '+' : '-';
            const absOffset = Math.abs(offsetMinutes);
            const offsetHours = pad(Math.floor(absOffset / 60));
            const offsetMins = pad(absOffset % 60);

            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}${sign}${offsetHours}:${offsetMins}`;
        }

        function formatDateForCsv(dateString) {
            const d = new Date(dateString);
            function pad(n) { return String(n).padStart(2, '0'); }
            const year = d.getFullYear();
            const month = pad(d.getMonth() + 1);
            const day = pad(d.getDate());
            const hours = pad(d.getHours());
            const minutes = pad(d.getMinutes());
            const seconds = pad(d.getSeconds());
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // --- Global State & Functions ---
        const configElements = {};

        function updateConfigVisibility(isHidden, animate = true) {
            // Use elements from the global state
            const {
                configContent, toggleConfigBtn, configChevron,
                configHeaderLeftGroup, planSelectorContainer,
                planSelectorLabel, planSelector, planSelectorPlaceholder
            } = configElements;

            // Guard against running before initialization
            if (!configContent) return;

            if(animate){
                configContent.classList.add('transition-all', 'duration-300', 'ease-in-out');
            } else {
                configContent.classList.remove('transition-all', 'duration-300', 'ease-in-out');
            }

            if (isHidden) {
                configContent.classList.add('hidden');
                toggleConfigBtn.querySelector('span').textContent = 'Show';
                configChevron.style.transform = 'rotate(-180deg)';

                // Move and restyle the plan selector
                if (planSelectorPlaceholder) {
                    planSelectorContainer.parentNode.replaceChild(planSelectorPlaceholder, planSelectorContainer);
                    configHeaderLeftGroup.appendChild(planSelectorContainer);
                    planSelectorContainer.classList.add('flex', 'items-center', 'gap-2');
                    planSelectorLabel.classList.remove('block', 'mb-1');
                    planSelector.classList.remove('w-full');
                    planSelector.classList.add('w-auto');
                }

            } else {
                configContent.classList.remove('hidden');
                toggleConfigBtn.querySelector('span').textContent = 'Hide';
                configChevron.style.transform = 'rotate(0deg)';

                // Move and restyle the plan selector back
                if (planSelectorPlaceholder && planSelectorPlaceholder.parentNode) {
                    planSelectorPlaceholder.parentNode.replaceChild(planSelectorContainer, planSelectorPlaceholder);
                    planSelectorContainer.classList.remove('flex', 'items-center', 'gap-2');
                    planSelectorLabel.classList.add('block', 'mb-1');
                    planSelector.classList.add('w-full');
                    planSelector.classList.remove('w-auto');
                }
            }
        }

        // --- Event Listener and Initial Setup ---
        function clearPlanInputs() {
            // Clear the plan name
            document.getElementById('planName').value = '';
            updateOtherSupplierHeading();

            // Reset rate type to Flat
            document.querySelector('input[name="rateType"][value="flat"]').checked = true;
            document.getElementById('flatRateSection').classList.remove('hidden');
            document.getElementById('touRateSection').classList.add('hidden');

            // Clear flat rate inputs
            document.getElementById('otherSupplierRate').value = '';
            document.getElementById('otherSupplierFeedInRateFlat').value = '';

            // Clear daily connection fee
            document.getElementById('dailyConnectionRate').value = '';

            // Clear TOU inputs
            ['peak', 'shoulder', 'offpeak'].forEach(period => {
                document.getElementById(`tou_${period}_rate`).value = '';
                document.getElementById(`tou_${period}_start`).value = '00:00';
                document.getElementById(`tou_${period}_end`).value = '00:00';
                const container = document.querySelector(`[data-tou-period="${period}"]`);
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            });
            document.getElementById('tou_controlled_load_rate').value = '';
            document.getElementById('otherSupplierFeedInRateTou').value = '';

            // Clear demand tariff inputs
            document.getElementById('enableDemandTariff').checked = false;
            document.getElementById('demandTariffInputs').classList.add('hidden');
            document.getElementById('demandRate').value = '';
            document.getElementById('demandWindowStart').value = '16:00';
            document.getElementById('demandWindowEnd').value = '21:00';
            document.getElementById('demandDaysContainer').querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

            saveAllSettings();
        }

        function applyPlanTemplate() {
            const stateSelector = document.getElementById('stateSelector');
            const planSelector = document.getElementById('planSelector');
            const state = stateSelector.value;
            const planName = planSelector.value;

            if (!state || !planName) {
                if(planName === '') { // This is the "-- Custom --" selection
                    clearPlanInputs();
                }
                return;
            }

            const template = supplierTemplates[state][planName];
            if (!template) return;

            document.getElementById('planName').value = planName;
            updateOtherSupplierHeading();

            document.querySelector(`input[name="rateType"][value="${template.rateType}"]`).checked = true;
            if (template.rateType === 'tou') {
                document.getElementById('flatRateSection').classList.add('hidden');
                document.getElementById('touRateSection').classList.remove('hidden');
                document.getElementById('otherSupplierFeedInRateTou').value = template.feedIn || 0;
                document.getElementById('tou_controlled_load_rate').value = template.cl || 0;

                ['peak', 'shoulder', 'offpeak'].forEach(period => {
                    const periodConfig = template.tou[period];
                    if (periodConfig) {
                        document.getElementById(`tou_${period}_rate`).value = periodConfig.rate || 0;
                        if (period !== 'offpeak') {
                            document.getElementById(`tou_${period}_start`).value = periodConfig.start || '00:00';
                            document.getElementById(`tou_${period}_end`).value = periodConfig.end || '00:00';

                            const container = document.querySelector(`[data-tou-period="${period}"]`);
                            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                cb.checked = (periodConfig.days || []).includes(parseInt(cb.value));
                            });
                        }
                    }
                });
            } else {
                document.getElementById('flatRateSection').classList.remove('hidden');
                document.getElementById('touRateSection').classList.add('hidden');
                document.getElementById('otherSupplierRate').value = template.flat || 0;
                document.getElementById('otherSupplierFeedInRateFlat').value = template.feedIn || 0;
            }

            document.getElementById('dailyConnectionRate').value = template.daily || 0;

            const demand = template.demand || { e: false };
            document.getElementById('enableDemandTariff').checked = demand.e;
            if (demand.e) {
                document.getElementById('demandTariffInputs').classList.remove('hidden');
                document.getElementById('demandRate').value = demand.r || 0;
                document.getElementById('demandWindowStart').value = demand.s || '16:00';
                document.getElementById('demandWindowEnd').value = demand.f || '21:00';
                document.getElementById('demandDaysContainer').querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = (demand.days || []).includes(parseInt(cb.value));
                });
            } else {
                document.getElementById('demandTariffInputs').classList.add('hidden');
            }

            saveAllSettings();
        }

        function updateOtherSupplierHeading() {
            const heading = document.getElementById('otherSupplierHeading');
            const planName = document.getElementById('planName').value.trim();
            heading.textContent = planName ? `${planName} Details` : 'Other Supplier Details';
        }

        function saveAllSettings() {
            localStorage.setItem('rateType', document.querySelector('input[name="rateType"]:checked').value);
            localStorage.setItem('flatRate', document.getElementById('otherSupplierRate').value);
            localStorage.setItem('flatFeedInRate', document.getElementById('otherSupplierFeedInRateFlat').value);
            localStorage.setItem('dailyConnectionRate', document.getElementById('dailyConnectionRate').value);

            const getPeriodSettings = (period) => {
                const container = document.querySelector(`[data-tou-period="${period}"]`);
                if (!container) return {};
                const rate = document.getElementById(`tou_${period}_rate`).value;
                if (period === 'offpeak') {
                    return { rate: rate };
                }
                const days = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
                return {
                    rate: rate,
                    start: document.getElementById(`tou_${period}_start`).value,
                    end: document.getElementById(`tou_${period}_end`).value,
                    days: days
                };
            };

            const touConfig = {
                peak: getPeriodSettings('peak'),
                shoulder: getPeriodSettings('shoulder'),
                offpeak: getPeriodSettings('offpeak'),
                controlledLoad: document.getElementById('tou_controlled_load_rate').value,
                feedIn: document.getElementById('otherSupplierFeedInRateTou').value,
            };
            localStorage.setItem('touConfig', JSON.stringify(touConfig));

            localStorage.setItem('selectedState', document.getElementById('stateSelector').value);
            localStorage.setItem('selectedPlan', document.getElementById('planSelector').value);
            localStorage.setItem('planName', document.getElementById('planName').value);

            const demandSettings = {
                enabled: document.getElementById('enableDemandTariff').checked,
                rate: document.getElementById('demandRate').value,
                start: document.getElementById('demandWindowStart').value,
                end: document.getElementById('demandWindowEnd').value,
                days: Array.from(document.getElementById('demandDaysContainer').querySelectorAll('input:checked')).map(cb => parseInt(cb.value))
            };
            localStorage.setItem('demandSettings', JSON.stringify(demandSettings));
        }

        window.addEventListener('DOMContentLoaded', () => {
            // Populate the global state object
            configElements.configHeader = document.getElementById('configHeader');
            configElements.toggleConfigBtn = document.getElementById('toggleConfigBtn');
            configElements.configContent = document.getElementById('configContent');
            configElements.configChevron = document.getElementById('configChevron');
            configElements.configHeaderLeftGroup = document.getElementById('configHeaderLeftGroup');
            configElements.planSelectorContainer = document.getElementById('planSelectorContainer');
            configElements.planSelectorLabel = document.getElementById('planSelectorLabel');
            configElements.planSelector = document.getElementById('planSelector');
            configElements.planSelectorPlaceholder = document.createElement('div');
            configElements.planSelectorPlaceholder.id = 'plan-selector-placeholder';

            // Initial setup: store original parent and insert placeholder
            const originalParent = configElements.planSelectorContainer.parentNode;
            originalParent.replaceChild(configElements.planSelectorPlaceholder, configElements.planSelectorContainer);
            originalParent.replaceChild(configElements.planSelectorContainer, configElements.planSelectorPlaceholder);

            const isConfigHidden = localStorage.getItem('configHidden') === 'true';
            updateConfigVisibility(isConfigHidden, false);

            const toggleHandler = () => {
                const isCurrentlyHidden = configElements.configContent.classList.contains('hidden');
                updateConfigVisibility(!isCurrentlyHidden);
                localStorage.setItem('configHidden', !isCurrentlyHidden);
            };

            configElements.configHeader.addEventListener('click', toggleHandler);

            // Stop clicks on the dropdown from toggling the config section
            configElements.planSelectorContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            const apiKeyInput = document.getElementById('apiKey');
            const savedApiKey = localStorage.getItem('amberApiKey');
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }

            Chart.Tooltip.positioners.cursor = function(items, eventPosition) {
                return eventPosition;
            };

            const verticalHighlightPlugin = {
                id: 'verticalHighlight',
                beforeDatasetsDraw: (chart) => {
                    const activeElements = chart.tooltip?.getActiveElements();
                    if (activeElements && activeElements.length > 0) {
                        const ctx = chart.ctx;
                        const activeElement = activeElements[0];
                        const index = activeElement.index;
                        const xAxis = chart.scales.x;
                        
                        if (xAxis && index !== undefined) {
                            const x = xAxis.getPixelForValue(index);
                            const topY = chart.chartArea.top;
                            const bottomY = chart.chartArea.bottom;
                            const categoryWidth = xAxis.getPixelForValue(1) - xAxis.getPixelForValue(0);

                            ctx.save();
                            ctx.fillStyle = 'rgba(220, 220, 220, 0.4)';
                            ctx.fillRect(x - categoryWidth / 2, topY, categoryWidth, bottomY - topY);
                            ctx.restore();
                        }
                    }
                }
            };
            Chart.register(verticalHighlightPlugin);


            const endDateInput = document.getElementById('endDate');
            const startDateInput = document.getElementById('startDate');
            
            const savedStartDate = localStorage.getItem('startDate');
            const savedEndDate = localStorage.getItem('endDate');
            
            const today = new Date();
            const maxDate = formatForInput(today);
            startDateInput.setAttribute('max', maxDate);

            if (savedStartDate && savedEndDate) {
                startDateInput.value = savedStartDate;
                endDateInput.value = savedEndDate;
            } else {
                const now = new Date();
                const firstDayOfCurrentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDayOfCurrentMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                startDateInput.value = formatForInput(firstDayOfCurrentMonth);
                endDateInput.value = formatForInput(lastDayOfCurrentMonth);
            }


            const rateTypeSelector = document.getElementById('rateTypeSelector');
            const flatRateSection = document.getElementById('flatRateSection');
            const touRateSection = document.getElementById('touRateSection');
            
            const stateSelector = document.getElementById('stateSelector');
            const planSelector = document.getElementById('planSelector');
            const planNameInput = document.getElementById('planName');

            const enableDemandCheckbox = document.getElementById('enableDemandTariff');
            const demandInputsDiv = document.getElementById('demandTariffInputs');

            const customPlans = JSON.parse(localStorage.getItem('customSupplierPlans')) || {};
            for (const state in customPlans) {
                if (!supplierTemplates[state]) {
                    supplierTemplates[state] = {};
                }
                for (const planName in customPlans[state]) {
                    supplierTemplates[state][planName] = customPlans[state][planName];
                }
            }
            
            Object.keys(supplierTemplates).forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state;
                stateSelector.appendChild(option);
            });
            
            function loadAllSettings() {
                const savedState = localStorage.getItem('selectedState') || 'NSW';
                stateSelector.value = savedState;
                updatePlanSelector(savedState);
                
                const savedPlan = localStorage.getItem('selectedPlan');
                if(savedPlan) planSelector.value = savedPlan;
                
                const savedPlanName = localStorage.getItem('planName');
                if(savedPlanName) {
                    planNameInput.value = savedPlanName;
                    updateOtherSupplierHeading();
                }

                const savedRateType = localStorage.getItem('rateType');
                if (savedRateType) {
                    document.querySelector(`input[name="rateType"][value="${savedRateType}"]`).checked = true;
                    if (savedRateType === 'tou') {
                        flatRateSection.classList.add('hidden');
                        touRateSection.classList.remove('hidden');
                    } else {
                        flatRateSection.classList.remove('hidden');
                        touRateSection.classList.add('hidden');
                    }
                }
                
                const savedFlatRate = localStorage.getItem('flatRate');
                if (savedFlatRate) document.getElementById('otherSupplierRate').value = savedFlatRate;
                
                const savedFlatFeedIn = localStorage.getItem('flatFeedInRate');
                if (savedFlatFeedIn) document.getElementById('otherSupplierFeedInRateFlat').value = savedFlatFeedIn;
                
                const savedTouConfig = localStorage.getItem('touConfig');
                if (savedTouConfig) {
                    const config = JSON.parse(savedTouConfig);
                    document.getElementById('otherSupplierFeedInRateTou').value = config.feedIn;
                    document.getElementById('tou_controlled_load_rate').value = config.controlledLoad;

                    const setPeriodSettings = (period, settings) => {
                        if (!settings) return;
                        document.getElementById(`tou_${period}_rate`).value = settings.rate;
                         if (period !== 'offpeak') {
                            document.getElementById(`tou_${period}_start`).value = settings.start;
                            document.getElementById(`tou_${period}_end`).value = settings.end;
                            const container = document.querySelector(`[data-tou-period="${period}"]`);
                            container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                                cb.checked = (settings.days || []).includes(parseInt(cb.value));
                            });
                        }
                    };
                    setPeriodSettings('peak', config.peak);
                    setPeriodSettings('shoulder', config.shoulder);
                    setPeriodSettings('offpeak', config.offpeak);
                }

                const savedDailyConnectionRate = localStorage.getItem('dailyConnectionRate');
                if (savedDailyConnectionRate) document.getElementById('dailyConnectionRate').value = savedDailyConnectionRate;
                
                const savedDemandSettings = localStorage.getItem('demandSettings');
                if (savedDemandSettings) {
                    const settings = JSON.parse(savedDemandSettings);
                    enableDemandCheckbox.checked = settings.enabled;
                    document.getElementById('demandRate').value = settings.rate;
                    document.getElementById('demandWindowStart').value = settings.start;
                    document.getElementById('demandWindowEnd').value = settings.end;
                    if (settings.enabled) {
                        demandInputsDiv.classList.remove('hidden');
                    }
                    document.getElementById('demandDaysContainer').querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = (settings.days || []).includes(parseInt(cb.value));
                    });
                }
            }
            
            loadAllSettings();
            
            stateSelector.addEventListener('change', (e) => {
                updatePlanSelector(e.target.value);
                localStorage.setItem('selectedState', e.target.value);
                planSelector.value = '';
            });
            planSelector.addEventListener('change', () => {
                applyPlanTemplate();
                const resultsSection = document.getElementById('resultsSection');
                if (!resultsSection.classList.contains('hidden')) {
                    document.getElementById('fetchData').click();
                } else {
                    updatePlanSavings();
                }
            });
            planNameInput.addEventListener('input', () => {
                updateOtherSupplierHeading();
                saveAllSettings();
            });

            enableDemandCheckbox.addEventListener('change', (e) => {
                demandInputsDiv.classList.toggle('hidden', !e.target.checked);
                saveAllSettings();
            });

            document.querySelectorAll('#configContent input, #configContent select').forEach(el => {
                if (el.id !== 'stateSelector' && el.id !== 'planSelector' && el.id !== 'planName') {
                     el.addEventListener('input', saveAllSettings);
                }
            });

            rateTypeSelector.addEventListener('change', () => {
                const selectedType = document.querySelector('input[name="rateType"]:checked').value;
                if (selectedType === 'tou') {
                    flatRateSection.classList.add('hidden');
                    touRateSection.classList.remove('hidden');
                } else {
                    flatRateSection.classList.remove('hidden');
                    touRateSection.classList.add('hidden');
                }
                saveAllSettings();
            });


            const downloadCsvButton = document.getElementById('downloadCsvButton');
            const csvDropdownMenu = document.getElementById('csvDropdownMenu');
            
            downloadCsvButton.addEventListener('click', (event) => {
                event.stopPropagation();
                if (!downloadCsvButton.disabled) {
                    csvDropdownMenu.classList.toggle('hidden');
                }
            });

            window.addEventListener('click', (event) => {
                if (!csvDropdownMenu.contains(event.target) && !downloadCsvButton.contains(event.target)) {
                    csvDropdownMenu.classList.add('hidden');
                }
            });

            document.getElementById('downloadFullIntervalCsv').addEventListener('click', (e) => {
                e.preventDefault();
                generateAndDownloadFullIntervalDataCSV();
                csvDropdownMenu.classList.add('hidden');
            });
            document.getElementById('downloadDailySummaryCsv').addEventListener('click', (e) => {
                e.preventDefault();
                generateAndDownloadDailySummariesCSV();
                csvDropdownMenu.classList.add('hidden');
            });
            document.getElementById('downloadResultsTableCsv').addEventListener('click', (e) => {
                e.preventDefault();
                generateAndDownloadResultsTableCSV();
                csvDropdownMenu.classList.add('hidden');
            });


            const settingsBtn = document.getElementById('settingsBtn');
            const settingsMenu = document.getElementById('settingsMenu');

            let settingsMenuHTML = `
                <button id="clearCacheBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center">
                    <span class="mr-2">🗑️</span>
                    <span>Clear Cached Data</span>
                </button>
                <div class="border-t border-gray-100"></div>
                <button id="clearCustomPlansBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center">
                    <span class="mr-2">🧹</span>
                    <span>Clear Custom Plans</span>
                </button>
            `;

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('name') === 'Rick') {
                settingsMenuHTML += `
                <div class="border-t border-gray-100"></div>
                <button id="saveCustomPlansForRick" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center">
                    <span class="mr-2">💾</span>
                    <span>Save Custom Plans</span>
                </button>
                <button id="showStatsForRick" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 flex items-center">
                    <span class="mr-2">📊</span>
                    <span>Show Stats</span>
                </button>
                `;
            }

            settingsMenu.innerHTML = settingsMenuHTML;

            if (urlParams.get('name') === 'Rick') {
                document.getElementById('saveCustomPlansForRick').addEventListener('click', saveCustomPlansForRick);
                document.getElementById('showStatsForRick').addEventListener('click', showStatsForRick);
            }

            settingsBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                settingsMenu.classList.toggle('hidden');
            });

            window.addEventListener('click', (event) => {
                if (!settingsMenu.contains(event.target) && !settingsBtn.contains(event.target)) {
                    settingsMenu.classList.add('hidden');
                }
            });

            document.getElementById('clearCustomPlansBtn').addEventListener('click', () => {
                const confirmed = window.confirm("Are you sure you want to delete ALL your saved custom plans? This action cannot be undone.");
                if (confirmed) {
                    const oldCustomPlans = JSON.parse(localStorage.getItem('customSupplierPlans')) || {};

                    localStorage.removeItem('customSupplierPlans');

                    for (const state in oldCustomPlans) {
                        if (supplierTemplates[state]) {
                            for (const planName in oldCustomPlans[state]) {
                                if (supplierTemplates[state][planName]) {
                                    delete supplierTemplates[state][planName];
                                }
                            }
                        }
                    }

                    const stateSelector = document.getElementById('stateSelector');
                    const planSelector = document.getElementById('planSelector');
                    const previouslySelectedPlanName = planSelector.value;

                    updatePlanSelector(stateSelector.value);

                    let planExists = false;
                    if (supplierTemplates[stateSelector.value] && supplierTemplates[stateSelector.value][previouslySelectedPlanName]) {
                        planExists = true;
                    }

                    if (!planExists && previouslySelectedPlanName !== '') {
                        planSelector.value = '';
                        clearPlanInputs();
                    }

                    const cacheMessageEl = document.getElementById('cacheMessage');
                    cacheMessageEl.textContent = 'Custom plans cleared successfully!';
                    cacheMessageEl.className = 'text-sm mt-2 font-medium text-green-600';
                    setTimeout(() => { cacheMessageEl.textContent = ''; }, 3000);
                }
            });

            const clearCacheBtn = document.getElementById('clearCacheBtn');
            document.getElementById('gstToggle').addEventListener('change', () => {
                if (lastResultDataPayload) {
                    displayResults(
                        lastResultDataPayload.channelTotals,
                        lastResultDataPayload.overallAmberCost,
                        lastResultDataPayload.overallOtherCost,
                        lastResultDataPayload.startDateStr,
                        lastResultDataPayload.endDateStr,
                        lastResultDataPayload.numDays,
                        lastResultDataPayload.demandTariffInfo,
                        lastResultDataPayload.otherDemandTariffInfo
                    );
                }
            });

            clearCacheBtn.addEventListener('click', () => {
                const confirmed = window.confirm("Are you sure you want to clear all cached data? This action cannot be undone.");
                if (!confirmed) {
                    return;
                }

                const cacheMessageEl = document.getElementById('cacheMessage');
                cacheMessageEl.textContent = 'Clearing cache...';
                cacheMessageEl.className = 'text-sm mt-2 font-medium text-yellow-600';

                const request = indexedDB.deleteDatabase(DB_NAME);

                request.onsuccess = function() {
                    cachedChannelData = null; 
                    dailySummaries = {};
                    lastFetchedStartDate = null;
                    lastFetchedEndDate = null;
                    currentSiteId = null;
                    document.getElementById('calendar-container').innerHTML = '';
                    
                    cacheMessageEl.textContent = 'Cache cleared successfully!';
                    cacheMessageEl.className = 'text-sm mt-2 font-medium text-green-600';
                    setTimeout(() => { cacheMessageEl.textContent = ''; }, 3000);
                };

                request.onerror = function() {
                    console.error("Couldn't delete database");
                    cacheMessageEl.textContent = 'Error clearing cache.';
                    cacheMessageEl.className = 'text-sm mt-2 font-medium text-red-600';
                    setTimeout(() => { cacheMessageEl.textContent = ''; }, 3000);
                };

                request.onblocked = function() {
                    console.warn("Couldn't delete database due to connections still open.");
                    cacheMessageEl.textContent = 'Cache is busy. Please refresh the page and try again.';
                    cacheMessageEl.className = 'text-sm mt-2 font-medium text-orange-600';
                     setTimeout(() => { cacheMessageEl.textContent = ''; }, 5000);
                };
            });
        });

        // --- Data Processing Helper ---
        function processUsageData(usageArray, channelTotalsObject, shouldCalculateTotals) {
            usageArray.forEach(item => {
                // Ensure time is processed only once
                if (!item.processedTime) {
                    const itemDate = new Date(item.nemTime);
                    // The nemTime is the END of the interval. We adjust it back by one second
                    // to ensure all calculations (TOU, daily bucketing) use the date/time
                    // the usage actually occurred in, correctly handling the midnight boundary.
                    itemDate.setSeconds(itemDate.getSeconds() - 1);
                    item.nemTime = toLocalIsoWithOffset(itemDate);
                    item.processedTime = true;
                }

                const channelId = item.channelIdentifier;
                if (!channelTotalsObject[channelId]) return;
                
                const channelData = channelTotalsObject[channelId];
                const kwh = parseFloat(item.kwh) || 0;
                const perKwh = parseFloat(item.perKwh) || 0;
                
                if (shouldCalculateTotals) {
                    channelData.totalKWh += kwh;
                    channelData.totalAmberCost += (perKwh / 100) * kwh;
                }
                
                channelData.usageData.push(item);
            });
        }


        function updatePlanSelector(selectedState) {
            const planSelector = document.getElementById('planSelector');
            planSelector.innerHTML = '<option value="">-- Custom --</option>';
            if (supplierTemplates[selectedState]) {
                Object.keys(supplierTemplates[selectedState]).forEach(planName => {
                    const option = document.createElement('option');
                    option.value = planName;
                    option.textContent = planName;
                    if (!originalSupplierTemplates[selectedState] || !originalSupplierTemplates[selectedState][planName]) {
                        option.style.color = '#1a56db';
                    }
                    planSelector.appendChild(option);
                });
            }
        }

        function createPlanObjectFromForm() {
            const rateType = document.querySelector('input[name="rateType"]:checked').value;
            const isDemandEnabled = document.getElementById('enableDemandTariff').checked;

            const demandConfig = {
                e: isDemandEnabled,
                r: isDemandEnabled ? parseFloat(document.getElementById('demandRate').value) : 0,
                s: isDemandEnabled ? document.getElementById('demandWindowStart').value : '16:00',
                f: isDemandEnabled ? document.getElementById('demandWindowEnd').value : '21:00',
                days: isDemandEnabled ? Array.from(document.getElementById('demandDaysContainer').querySelectorAll('input:checked')).map(cb => parseInt(cb.value)) : []
            };

            if (rateType === 'flat') {
                return {
                    rateType: 'flat',
                    daily: parseFloat(document.getElementById('dailyConnectionRate').value),
                    flat: parseFloat(document.getElementById('otherSupplierRate').value),
                    feedIn: parseFloat(document.getElementById('otherSupplierFeedInRateFlat').value),
                    demand: demandConfig
                };
            } else { // tou
                const getPeriodSettings = (period) => {
                    const container = document.querySelector(`[data-tou-period="${period}"]`);
                    if (!container) return {};

                    const rate = parseFloat(document.getElementById(`tou_${period}_rate`).value);

                    if (period === 'offpeak') {
                        return { rate: rate };
                    }

                    const days = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => parseInt(cb.value));
                    return {
                        rate: rate,
                        start: document.getElementById(`tou_${period}_start`).value,
                        end: document.getElementById(`tou_${period}_end`).value,
                        days: days
                    };
                };

                return {
                    rateType: 'tou',
                    daily: parseFloat(document.getElementById('dailyConnectionRate').value),
                    feedIn: parseFloat(document.getElementById('otherSupplierFeedInRateTou').value),
                    cl: parseFloat(document.getElementById('tou_controlled_load_rate').value),
                    tou: {
                        peak: getPeriodSettings('peak'),
                        shoulder: getPeriodSettings('shoulder'),
                        offpeak: getPeriodSettings('offpeak')
                    },
                    demand: demandConfig
                };
            }
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        async function showStatsForRick() {
            // 1. LocalStorage
            let totalLocalStorageSize = 0;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                totalLocalStorageSize += (key.length + value.length);
            }
            const customPlans = JSON.parse(localStorage.getItem('customSupplierPlans') || '{}');
            let planCount = 0;
            for (const state in customPlans) {
                planCount += Object.keys(customPlans[state]).length;
            }

            // 2. IndexedDB / Origin Storage
            let storageEstimate = { usage: 'N/A', quota: 'N/A' };
            if (navigator.storage && navigator.storage.estimate) {
                const estimate = await navigator.storage.estimate();
                storageEstimate.usage = formatBytes(estimate.usage);
                storageEstimate.quota = formatBytes(estimate.quota);
            }

            // 3. JS Memory
            let memoryInfo = {
                used: 'N/A',
                limit: 'N/A',
                note: '(performance.memory API not supported)'
            };
            if (performance.memory) {
                memoryInfo.used = formatBytes(performance.memory.usedJSHeapSize);
                memoryInfo.limit = formatBytes(performance.memory.jsHeapSizeLimit);
                memoryInfo.note = '(Chromium-only feature)';
            }


            const modal = document.createElement('div');
            modal.id = 'rick-stats-modal';
            modal.style.position = 'fixed';
            modal.style.zIndex = '100';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.overflow = 'auto';
            modal.style.backgroundColor = 'rgba(0,0,0,0.4)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';


            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = '#fefefe';
            modalContent.style.margin = 'auto';
            modalContent.style.padding = '20px';
            modalContent.style.border = '1px solid #888';
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '600px';
            modalContent.style.borderRadius = '8px';
            modalContent.className = 'text-gray-800';

            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.className = 'close-btn'; // Add a class for easier selection
            closeBtn.style.color = '#aaa';
            closeBtn.style.float = 'right';
            closeBtn.style.fontSize = '28px';
            closeBtn.style.fontWeight = 'bold';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            const modalHeader = document.createElement('h2');
            modalHeader.textContent = 'Application Storage & Memory Stats';
            modalHeader.className = 'text-xl font-bold mb-4';

            const statsTable = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Metric</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Usage</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Details</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td class="px-4 py-2 font-medium">LocalStorage</td>
                            <td class="px-4 py-2">${formatBytes(totalLocalStorageSize)}</td>
                            <td class="px-4 py-2">${localStorage.length} keys, including ${planCount} custom plans.</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-2 font-medium">IndexedDB / Origin Storage</td>
                            <td class="px-4 py-2">${storageEstimate.usage} of ${storageEstimate.quota}</td>
                            <td class="px-4 py-2">Includes cached daily usage data.</td>
                        </tr>
                        <tr>
                            <td class="px-4 py-2 font-medium">JavaScript Memory</td>
                            <td class="px-4 py-2">${memoryInfo.used} of ${memoryInfo.limit}</td>
                            <td class="px-4 py-2">${memoryInfo.note}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(modalHeader);

            const tableContainer = document.createElement('div');
            tableContainer.innerHTML = statsTable;
            modalContent.appendChild(tableContainer);

            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function saveCustomPlansForRick() {
            const customPlans = JSON.parse(localStorage.getItem('customSupplierPlans')) || {};
            let outputLines = [];

            for (const state in customPlans) {
                for (const planName in customPlans[state]) {
                    const planDetails = customPlans[state][planName];
                    const planDetailsString = JSON.stringify(planDetails);
                    outputLines.push(`"${planName}": ${planDetailsString}`);
                }
            }

            if (outputLines.length === 0) {
                alert('No custom plans to save.');
                return;
            }

            const output = outputLines.join(',\n');

            const modal = document.createElement('div');
            modal.id = 'rick-modal';
            modal.style.position = 'fixed';
            modal.style.zIndex = '100';
            modal.style.left = '0';
            modal.style.top = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.overflow = 'auto';
            modal.style.backgroundColor = 'rgba(0,0,0,0.4)';
            modal.style.display = 'flex';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';

            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = '#fefefe';
            modalContent.style.margin = 'auto';
            modalContent.style.padding = '20px';
            modalContent.style.border = '1px solid #888';
            modalContent.style.width = '80%';
            modalContent.style.maxWidth = '700px';
            modalContent.style.borderRadius = '8px';

            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.color = '#aaa';
            closeBtn.style.float = 'right';
            closeBtn.style.fontSize = '28px';
            closeBtn.style.fontWeight = 'bold';
            closeBtn.style.cursor = 'pointer';
            closeBtn.onclick = () => {
                document.body.removeChild(modal);
            };

            const modalHeader = document.createElement('h2');
            modalHeader.textContent = 'Custom Plans for Code';
            modalHeader.style.marginBottom = '15px';

            const outputPre = document.createElement('pre');
            outputPre.textContent = output;
            outputPre.style.backgroundColor = '#eee';
            outputPre.style.padding = '10px';
            outputPre.style.border = '1px solid #ddd';
            outputPre.style.whiteSpace = 'pre-wrap';
            outputPre.style.wordBreak = 'break-all';

            const copyButton = document.createElement('button');
            copyButton.textContent = 'Copy to Clipboard';
            copyButton.className = 'bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-4';
            copyButton.onclick = () => {
                navigator.clipboard.writeText(output).then(() => {
                    copyButton.textContent = 'Copied!';
                    setTimeout(() => { copyButton.textContent = 'Copy to Clipboard'; }, 2000);
                }, (err) => {
                    console.error('Could not copy text: ', err);
                });
            };

            modalContent.appendChild(closeBtn);
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(outputPre);
            modalContent.appendChild(copyButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        function saveCustomPlan() {
            const state = document.getElementById('stateSelector').value;
            const planName = document.getElementById('planName').value.trim();

            if (!state || !planName) {
                return; // Don't save if no state or name
            }

            if (originalSupplierTemplates[state] && originalSupplierTemplates[state][planName]) {
                return;
            }

            const plan = createPlanObjectFromForm();

            const customPlans = JSON.parse(localStorage.getItem('customSupplierPlans')) || {};
            if (!customPlans[state]) {
                customPlans[state] = {};
            }
            customPlans[state][planName] = plan;
            localStorage.setItem('customSupplierPlans', JSON.stringify(customPlans));

            if (!supplierTemplates[state]) {
                supplierTemplates[state] = {};
            }
            supplierTemplates[state][planName] = plan;

            updatePlanSelector(state);
            document.getElementById('planSelector').value = planName;
        }

        // --- Main Fetch and Calculation Logic ---
        document.getElementById('fetchData').addEventListener('click', async () => {
            saveCustomPlan();
            const resultsSection = document.getElementById('resultsSection');
            const calendarSection = document.getElementById('calendarSection');
            const messageContainer = document.getElementById('messageContainer');
            const messageEl = document.getElementById('message');
            const progressBar = document.getElementById('progressBar');
            const downloadCsvButton = document.getElementById('downloadCsvButton');
            const averageGraphContainer = document.getElementById('averageGraphContainer');
            const dailyGraphSection = document.getElementById('dailyGraphSection');

            resultsSection.classList.add('hidden');
            calendarSection.classList.add('hidden');
            averageGraphContainer.classList.add('hidden');
            dailyGraphSection.classList.add('hidden');
            downloadCsvButton.disabled = true;
            document.getElementById('results-table-container').innerHTML = '';
            messageEl.textContent = '';
            if (progressBar) progressBar.style.width = '0%';
            messageContainer.classList.add('hidden');
            
            if (dailyUsageChart) { dailyUsageChart.destroy(); dailyUsageChart = null; }
            if (usageChart) { usageChart.destroy(); usageChart = null; }

            const apiKey = document.getElementById('apiKey').value;
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;

            if (startDateValue !== lastFetchedStartDate || endDateValue !== lastFetchedEndDate) {
                amberCostBaseline = null;
            }
            
            localStorage.setItem('startDate', startDateValue);
            localStorage.setItem('endDate', endDateValue);
            
            if (!apiKey) {
                messageContainer.classList.remove('hidden');
                messageEl.textContent = 'Please enter your Amber API key.';
                return;
            }
            
            localStorage.setItem('amberApiKey', apiKey);

             if (!startDateValue || !endDateValue) {
                messageContainer.classList.remove('hidden');
                messageEl.textContent = 'Please select a start and end date.';
                return;
            }

            const overallStartDate = new Date(startDateValue + 'T00:00:00');
            let overallEndDate = new Date(endDateValue + 'T00:00:00');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (overallEndDate > today) {
                overallEndDate = today;
            }
            
            overallEndDate.setHours(23, 59, 59, 999); 

            if (overallEndDate < overallStartDate) {
                messageContainer.classList.remove('hidden');
                messageEl.textContent = 'End date cannot be before the start date.';
                return;
            }
            const numDays = Math.ceil((overallEndDate - overallStartDate) / (1000 * 60 * 60 * 24));

            const now = new Date();
            if (cachedChannelData && lastFetchTimestamp && (now - lastFetchTimestamp < 3600000) && startDateValue === lastFetchedStartDate && endDateValue === lastFetchedEndDate) {
                messageContainer.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                calendarSection.classList.remove('hidden');

                // Recalculate costs with potentially new plan settings
                const otherDemandInfo = calculateOtherDemandTariff(cachedChannelData, startDateValue, endDateValue);
                calculateOtherSupplierCosts(cachedChannelData, otherDemandInfo ? otherDemandInfo.cost : 0);
                const demandTariffInfo = calculateDemandTariff(cachedChannelData);

                const { summaries, monthlyDemandInfo } = precalculateDailySummaries(cachedAllChannelData);
                dailySummaries = summaries;
                demandInfoForTooltip = monthlyDemandInfo;

                let overallAmberCost = 0;
                let overallOtherCost = 0;
                let loopDate = new Date(overallStartDate);
                while (loopDate <= overallEndDate) {
                    const dateStr = formatForInput(loopDate);
                    const summary = dailySummaries[dateStr];
                    if (summary) {
                        overallAmberCost += summary.amberCost + (summary.amberDemandCost || 0) + (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                        const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
                        overallOtherCost += summary.otherCost + (summary.otherDemandCost || 0) + (otherDailyConnection / 100);
                    } else {
                         overallAmberCost += (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                         const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
                         overallOtherCost += (otherDailyConnection / 100);
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }

                if (amberCostBaseline === null) {
                    amberCostBaseline = overallAmberCost;
                }

                await displayResults(cachedChannelData, overallAmberCost, overallOtherCost, startDateValue, endDateValue, numDays, demandTariffInfo, otherDemandInfo);
                return; // Skip fetching
            }

            // If cache is not used, reset and fetch
            cachedChannelData = null;
            cachedAllChannelData = null;
            dailySummaries = {};

            messageContainer.classList.remove('hidden');
            
            const headers = { 'Authorization': `Bearer ${apiKey}`, 'accept': 'application/json' };

            try {
                messageEl.textContent = 'Fetching your site details...';
                const sitesResponse = await fetch(`${AMBER_API_URL}/sites`, { headers });
                 if (!sitesResponse.ok) {
                    if (sitesResponse.status === 403) {
                        throw new Error(`Authentication failed. Your API Key appears to be invalid. Please check and try again.`);
                    }
                    let detail = `Status: ${sitesResponse.status} ${sitesResponse.statusText}`;
                    try { const errorText = await sitesResponse.text(); detail = JSON.parse(errorText).message || errorText; } catch (e) { /* ignore */ }
                    throw new Error(`Failed to fetch sites. ${detail}`);
                }
                const sites = await sitesResponse.json();
                if (!sites || sites.length === 0) throw new Error('No sites found for this API key.');
                
                const site = sites[0];

                if (currentSiteId !== site.id) {
                    amberCostBaseline = null;
                }
                currentSiteId = site.id;
                const siteId = site.id;
                let modifiableChannels = [...site.channels];
                if (!modifiableChannels || modifiableChannels.length === 0) throw new Error('No channels found for this site.');

                messageEl.textContent = `Site found: ${siteId}. Preparing to fetch usage data...`;
                
                const db = await openDb();
                let selectedUsageData = [];
                let datesToFetch = [];
                let processedDays = 0;

                const cacheBoundary = new Date();
                cacheBoundary.setHours(0, 0, 0, 0);
                cacheBoundary.setDate(cacheBoundary.getDate() - 3);

                let currentDate = new Date(overallStartDate);
                while (currentDate <= overallEndDate) {
                    const dateStr = formatForInput(currentDate);
                    if (currentDate >= cacheBoundary) {
                        datesToFetch.push(dateStr);
                    } else {
                        const cacheKey = `${siteId}_${dateStr}`;
                        const cachedDayData = await getUsageData(db, cacheKey);
                        if (cachedDayData) {
                            messageEl.textContent = `Processing from cache: ${dateStr}`;
                            selectedUsageData.push(...cachedDayData);
                            processedDays++;
                            const progress = (processedDays / numDays) * 100;
                            if(progressBar) progressBar.style.width = `${progress}%`;
                        } else {
                            datesToFetch.push(dateStr);
                        }
                    }
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const fetchRanges = [];
                if (datesToFetch.length > 0) {
                    let rangeStart = datesToFetch[0];
                    let rangeEnd = datesToFetch[0];
                    const getDaysBetween = (start, end) => (new Date(end) - new Date(start)) / (1000 * 3600 * 24) + 1;

                    for (let i = 1; i < datesToFetch.length; i++) {
                        const nextDay = new Date(rangeEnd);
                        nextDay.setDate(nextDay.getDate() + 1);
                        if (datesToFetch[i] === formatForInput(nextDay) && getDaysBetween(rangeStart, datesToFetch[i]) <= 7) {
                            rangeEnd = datesToFetch[i];
                        } else {
                            fetchRanges.push({ start: rangeStart, end: rangeEnd });
                            rangeStart = datesToFetch[i];
                            rangeEnd = datesToFetch[i];
                        }
                    }
                    fetchRanges.push({ start: rangeStart, end: rangeEnd });
                }

                for (const range of fetchRanges) {
                    messageEl.textContent = `Fetching from Amber: ${range.start} to ${range.end}...`;
                    const usageUrl = `${AMBER_API_URL}/sites/${siteId}/usage?startDate=${range.start}&endDate=${range.end}`;
                    const usageResponse = await fetch(usageUrl, { headers });
                    const responseText = await usageResponse.text();
                     if (!usageResponse.ok) {
                        let detail = responseText;
                        try { detail = (JSON.parse(responseText)).message || responseText; } catch (e) { /* not JSON */ }
                        throw new Error(`Failed to fetch usage for ${range.start} to ${range.end}. Status: ${usageResponse.status}. Message: ${detail}`);
                    }
                    const apiResponseData = JSON.parse(responseText);

                    const filteredDataForRange = apiResponseData.filter(item => {
                        const itemDate = new Date(item.nemTime);
                        // The NEM time is the END of the interval. To get the date the usage occurred on, 
                        // we subtract a second to correctly handle the midnight boundary.
                        // e.g., nemTime 2025-01-02T00:00:00 becomes 2025-01-01T23:59:59, which correctly belongs to Jan 1st.
                        itemDate.setSeconds(itemDate.getSeconds() - 1);
                        const usageDateStr = formatForInput(itemDate);
                        return usageDateStr >= range.start && usageDateStr <= range.end;
                    });

                    selectedUsageData.push(...filteredDataForRange);

                    // Update progress based on days in this fetched range
                    const rangeStartDt = new Date(range.start + "T00:00:00");
                    const rangeEndDt = new Date(range.end + "T00:00:00");
                    const daysInThisRange = Math.round((rangeEndDt - rangeStartDt) / (1000 * 3600 * 24)) + 1;
                    processedDays += daysInThisRange;
                    const progress = (processedDays / numDays) * 100;
                    if(progressBar) progressBar.style.width = `${progress}%`;

                    const dailyData = {};
                    filteredDataForRange.forEach(item => {
                        const itemDate = new Date(item.nemTime);
                        itemDate.setSeconds(itemDate.getSeconds() - 1);
                        const usageDateStr = formatForInput(itemDate);
                        if (!dailyData[usageDateStr]) dailyData[usageDateStr] = [];
                        dailyData[usageDateStr].push(item);
                    });

                    for (const dateStr in dailyData) {
                        const dayDate = new Date(dateStr);
                        if (dayDate < cacheBoundary) {
                            await setUsageData(db, `${siteId}_${dateStr}`, dailyData[dateStr]);
                        }
                    }
                }

                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('fakeControlledLoad')) {
                    let clChannel = modifiableChannels.find(c => c.type === 'controlledLoad');
                    if (!clChannel) {
                        clChannel = { identifier: 'C', type: 'controlledLoad' };
                        modifiableChannels.push(clChannel);
                    }

                    let loopDate = new Date(overallStartDate);
                    while (loopDate <= overallEndDate) {
                        for (let hour = 1; hour < 5; hour++) {
                            for (let minute = 0; minute < 60; minute += 5) {
                                const fakeNemTime = new Date(loopDate);
                                fakeNemTime.setHours(hour, minute, 0, 0);

                                const endDate = new Date(fakeNemTime);
                                endDate.setMinutes(endDate.getMinutes() + 5);

                                selectedUsageData.push({
                                    nemTime: toLocalIsoWithOffset(endDate),
                                    channelIdentifier: clChannel.identifier,
                                    kwh: 0.25, // 0.25 kWh per 5 mins = 3kW rate. 4 hours * 3kW = 12kWh
                                    perKwh: 15,
                                    channelType: 'controlledLoad',
                                    tariffInformation: { demandWindow: false },
                                });
                            }
                        }
                        loopDate.setDate(loopDate.getDate() + 1);
                    }
                }

                messageEl.textContent = 'Loading all cached data for calendar...';

                const allCachedDates = await getAllCachedDates(db, siteId);
                const selectedDates = new Set();
                let d = new Date(overallStartDate);
                while (d <= overallEndDate) {
                    selectedDates.add(formatForInput(d));
                    d.setDate(d.getDate() + 1);
                }

                let otherCachedUsageData = [];
                for (const dateStr of allCachedDates) {
                    if (!selectedDates.has(dateStr)) {
                        const cachedDayData = await getUsageData(db, `${siteId}_${dateStr}`);
                        if (cachedDayData) {
                            otherCachedUsageData.push(...cachedDayData);
                        }
                    }
                }
                
                let channelTotalsSelectedPeriod = {};
                let channelTotalsAllData = {};
                modifiableChannels.forEach(c => {
                    const initial = { identifier: c.identifier, type: c.type, totalKWh: 0, totalAmberCost: 0, usageData: [] };
                    channelTotalsSelectedPeriod[c.identifier] = JSON.parse(JSON.stringify(initial));
                    channelTotalsAllData[c.identifier] = JSON.parse(JSON.stringify(initial));
                });

                processUsageData(selectedUsageData, channelTotalsSelectedPeriod, true);
                Object.values(channelTotalsSelectedPeriod).forEach(c => c.usageData.sort((a,b) => new Date(a.nemTime) - new Date(b.nemTime)));
                
                const allUsageData = [...selectedUsageData, ...otherCachedUsageData];
                // Reset processed time flag before re-processing
                allUsageData.forEach(item => item.processedTime = false);
                processUsageData(allUsageData, channelTotalsAllData, false);
                 Object.values(channelTotalsAllData).forEach(c => c.usageData.sort((a,b) => new Date(a.nemTime) - new Date(b.nemTime)));
                
                messageEl.textContent = 'Calculating costs...';

                lastFetchedStartDate = startDateValue;
                lastFetchedEndDate = endDateValue;
                cachedChannelData = channelTotalsSelectedPeriod;
                cachedAllChannelData = channelTotalsAllData;
                lastFetchTimestamp = new Date();
                
                const otherDemandInfo = calculateOtherDemandTariff(channelTotalsSelectedPeriod, startDateValue, endDateValue);
                calculateOtherSupplierCosts(channelTotalsSelectedPeriod, otherDemandInfo ? otherDemandInfo.cost : 0);
                
                const demandTariffInfo = calculateDemandTariff(channelTotalsSelectedPeriod);
                
                // Pre-calculate summaries for the entire cached period, with demand calculated monthly.
                const { summaries, monthlyDemandInfo } = precalculateDailySummaries(channelTotalsAllData);
                dailySummaries = summaries;
                demandInfoForTooltip = monthlyDemandInfo;

                let overallAmberCost = 0;
                let overallOtherCost = 0;
                let loopDate = new Date(overallStartDate);
                while (loopDate <= overallEndDate) {
                    const dateStr = formatForInput(loopDate);
                    const summary = dailySummaries[dateStr];
                    if (summary) {
                        overallAmberCost += summary.amberCost + (summary.amberDemandCost || 0) + (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                        const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
                        overallOtherCost += summary.otherCost + (summary.otherDemandCost || 0) + (otherDailyConnection / 100);
                    } else {
                         overallAmberCost += (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                         const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
                         overallOtherCost += (otherDailyConnection / 100);
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }

                if (amberCostBaseline === null) {
                    amberCostBaseline = overallAmberCost;
                }

                messageContainer.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                calendarSection.classList.remove('hidden');
                await displayResults(channelTotalsSelectedPeriod, overallAmberCost, overallOtherCost, startDateValue, endDateValue, numDays, demandTariffInfo, otherDemandInfo);

            } catch (error) {
                console.error('Error:', error);
                cachedChannelData = null;
                dailySummaries = {};
                messageContainer.classList.remove('hidden');
                messageEl.textContent = `Error: ${error.message}`;
            }
        });

        // --- Helper Functions ---
        
        function generateAndDownloadFullIntervalDataCSV() {
            if (!cachedChannelData) {
                alert("No data available to download. Please fetch data first.");
                return;
            }

            let csvContent = "nemTime,channelIdentifier,channelType,kWh,SpotPrice_cents_per_kWh\n";
            
            Object.values(cachedChannelData).forEach(channel => {
                if (!channel.usageData || channel.usageData.length === 0) return;
                channel.usageData.forEach(item => {
                    const nemTime = item.nemTime ? formatDateForCsv(item.nemTime) : '';
                    const kwh = (item.kwh !== undefined && item.kwh !== null) ? item.kwh : '';
                    const perKwh = (item.perKwh !== undefined && item.perKwh !== null) ? item.perKwh : '';
                    const row = `"${nemTime}",${channel.identifier},${channel.type},${kwh},${perKwh}\n`;
                    csvContent += row;
                });
            });

            downloadCSV(csvContent, `amber_full_interval_data_${lastFetchedStartDate}_to_${lastFetchedEndDate}.csv`);
        }

        function generateAndDownloadDailySummariesCSV() {
            if (Object.keys(dailySummaries).length === 0) {
                alert("No daily summary data available. Please fetch data first.");
                return;
            }

            const planName = document.getElementById('planName').value.trim() || 'Other Supplier';
            const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
            const amberFixedDailyCost = (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);

            let csvContent = "Date,Total Usage (kWh),Total Feed-in (kWh),Amber Usage Cost ($),Amber Demand Cost ($),Amber Fixed Cost ($),Amber Total ($),Other Usage Cost ($),Other Demand Cost ($),Other Fixed Cost ($),Other Total ($)\n";

            const sortedDates = Object.keys(dailySummaries).sort();

            for (const dateStr of sortedDates) {
                const summary = dailySummaries[dateStr];
                if (!summary) continue;

                const totalAmberCost = summary.amberCost + (summary.amberDemandCost || 0) + amberFixedDailyCost;
                const totalOtherCost = summary.otherCost + (summary.otherDemandCost || 0) + (otherDailyConnection / 100);

                const row = [
                    dateStr,
                    summary.totalInKwh.toFixed(3),
                    summary.totalOutKwh.toFixed(3),
                    summary.amberCost.toFixed(4),
                    (summary.amberDemandCost || 0).toFixed(4),
                    amberFixedDailyCost.toFixed(4),
                    totalAmberCost.toFixed(4),
                    summary.otherCost.toFixed(4),
                    (summary.otherDemandCost || 0).toFixed(4),
                    (otherDailyConnection / 100).toFixed(4),
                    totalOtherCost.toFixed(4)
                ].join(',');
                csvContent += row + '\n';
            }

            downloadCSV(csvContent, `amber_daily_summaries_${lastFetchedStartDate}_to_${lastFetchedEndDate}.csv`);
        }

        function generateAndDownloadResultsTableCSV() {
            const resultsTable = document.querySelector('#results-table-container table');
            if (!resultsTable) {
                alert("No results table available to download. Please fetch data first.");
                return;
            }

            let csv = [];
            const rows = resultsTable.querySelectorAll("tr");

            for (const row of rows) {
                const cols = row.querySelectorAll("td, th");
                const rowData = [];
                for (const col of cols) {
                    // Replace newlines and extra spaces within a cell, and wrap in quotes
                    let cellText = '"' + col.innerText.replace(/\s+/g, ' ').trim() + '"';
                    rowData.push(cellText);
                }
                csv.push(rowData.join(","));
            }

            downloadCSV(csv.join("\n"), `amber_results_table_${lastFetchedStartDate}_to_${lastFetchedEndDate}.csv`);
        }

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getTouRate(date, touConfig, fallbackRate) {
            const day = date.getDay(); // 0 = Sunday, 1 = Monday, ...
            const time = date.getHours() * 100 + date.getMinutes(); // e.g., 14:30 -> 1430

            const checkPeriod = (period) => {
                if (!period || !period.days || !period.start || !period.end) return false;
                if (!period.days.includes(day)) return false;
        
                const startTime = parseInt(period.start.replace(':', ''));
                const endTime = parseInt(period.end.replace(':', ''));
        
                // Handle overnight periods (e.g., 22:00 to 07:00)
                if (startTime > endTime) {
                    return time >= startTime || time < endTime;
                } else {
                    return time >= startTime && time < endTime;
                }
            };
        
            if (checkPeriod(touConfig.peak)) return parseFloat(touConfig.peak.rate) || 0;
            if (checkPeriod(touConfig.shoulder)) return parseFloat(touConfig.shoulder.rate) || 0;

            // Off-peak is now the default catch-all.
            if (touConfig.offpeak && touConfig.offpeak.rate) {
                return parseFloat(touConfig.offpeak.rate);
            }
        
            return fallbackRate; // Fallback if offpeak rate isn't defined.
        }
        
        function calculateOtherSupplierCosts(channelTotals, otherDemandCost, planConfig = null) {
            const rateType = planConfig ? planConfig.rateType : document.querySelector('input[name="rateType"]:checked').value;

            if (rateType === 'flat') {
                const otherSupplierRate = planConfig ? planConfig.flat : (parseFloat(document.getElementById('otherSupplierRate').value) || 0);
                const feedInRate = planConfig ? planConfig.feedIn : (parseFloat(document.getElementById('otherSupplierFeedInRateFlat').value) || 0);
                
                Object.values(channelTotals).forEach(c => {
                    let totalKwhForPeriod = c.usageData.reduce((acc, item) => acc + (parseFloat(item.kwh) || 0), 0);
                    if (c.type === 'feedIn') {
                        c.totalOtherCost = -1 * (totalKwhForPeriod * feedInRate) / 100;
                    } else if (c.type === 'general') {
                        c.totalOtherCost = (totalKwhForPeriod * otherSupplierRate) / 100 + otherDemandCost;
                    } else {
                         c.totalOtherCost = (totalKwhForPeriod * otherSupplierRate) / 100;
                    }
                });
            } else { // 'tou'
                const touConfig = planConfig ? planConfig.tou : JSON.parse(localStorage.getItem('touConfig') || '{}');
                const feedInRate = planConfig ? planConfig.feedIn : (parseFloat(JSON.parse(localStorage.getItem('touConfig') || '{}').feedIn) || 0);
                const controlledLoadRate = planConfig ? planConfig.cl : (parseFloat(JSON.parse(localStorage.getItem('touConfig') || '{}').controlledLoad) || 0);
                const fallbackRate = planConfig ? 0 : (parseFloat(document.getElementById('otherSupplierRate').value) || 0);

                Object.values(channelTotals).forEach(c => {
                    let channelOtherCost = 0;
                    if (c.type === 'feedIn') {
                        let totalKwhForPeriod = c.usageData.reduce((acc, item) => acc + (parseFloat(item.kwh) || 0), 0);
                        channelOtherCost = -1 * (totalKwhForPeriod * feedInRate) / 100;
                    } else if (c.type === 'controlledLoad') {
                        let totalKwhForPeriod = c.usageData.reduce((acc, item) => acc + (parseFloat(item.kwh) || 0), 0);
                        channelOtherCost = (totalKwhForPeriod * controlledLoadRate) / 100;
                    }
                    else if (c.type === 'general') { 
                        channelOtherCost = c.usageData.reduce((total, item) => {
                            const itemDate = new Date(item.nemTime);
                            const rateForInterval = getTouRate(itemDate, touConfig, fallbackRate);
                            return total + ((parseFloat(item.kwh) || 0) * rateForInterval / 100);
                        }, 0);
                        channelOtherCost += otherDemandCost;
                    }
                    c.totalOtherCost = channelOtherCost;
                });
            }
        }
        
        function calculateDemandTariff(channelTotals) {
            const generalChannel = Object.values(channelTotals).find(c => c.type === 'general');

            if (!generalChannel || !generalChannel.usageData || generalChannel.usageData.length === 0) {
                return { cost: 0, maxDemandKwh: 0, demandDays: 0, maxDemandTime: null };
            }

            const demandWindowUsage = generalChannel.usageData.filter(item =>
                item.tariffInformation && item.tariffInformation.demandWindow === true
            );

            if (demandWindowUsage.length === 0) {
                return { cost: 0, maxDemandKwh: 0, demandDays: 0, maxDemandTime: null };
            }

            const thirtyMinChunks = {};
            demandWindowUsage.forEach(item => {
                const itemDate = new Date(item.nemTime);
                const minutes = itemDate.getMinutes();
                itemDate.setSeconds(0, 0);

                if (minutes < 30) {
                    itemDate.setMinutes(0);
                } else {
                    itemDate.setMinutes(30);
                }
                const blockStartTime = itemDate.toISOString();

                if (!thirtyMinChunks[blockStartTime]) {
                    thirtyMinChunks[blockStartTime] = 0;
                }
                thirtyMinChunks[blockStartTime] += (parseFloat(item.kwh) || 0);
            });

            let maxDemandKwh = 0;
            let maxDemandTime = null;

            for (const startTime in thirtyMinChunks) {
                if (thirtyMinChunks[startTime] > maxDemandKwh) {
                    maxDemandKwh = thirtyMinChunks[startTime];
                    maxDemandTime = startTime;
                }
            }
            
            if (maxDemandKwh === 0) {
                 return { cost: 0, maxDemandKwh: 0, demandDays: 0, maxDemandTime: null };
            }

            const demandDaysSet = new Set(
                demandWindowUsage.map(item => item.nemTime.substring(0, 10))
            );
            const numberOfDemandDays = demandDaysSet.size;

            const demandTariffCost = maxDemandKwh * 2 * (AMBER_DEMAND_TARIFF_COST_PER_KW_CENTS / 100) * numberOfDemandDays;

            return {
                cost: demandTariffCost,
                maxDemandKwh: maxDemandKwh,
                demandDays: numberOfDemandDays,
                maxDemandTime: maxDemandTime
            };
        }

        function calculateOtherDemandTariff(channelTotals, startDateStr, endDateStr, planConfig = null) {
            const isEnabled = planConfig ? planConfig.demand.e : document.getElementById('enableDemandTariff').checked;
            if (!isEnabled) return { cost: 0, maxDemandKwh: 0, maxDemandTime: null, dailyCharge: 0 };
            
            const demandDays = planConfig ? planConfig.demand.days : (JSON.parse(localStorage.getItem('demandSettings') || '{}').days || []);
            if(demandDays.length === 0) return { cost: 0, maxDemandKwh: 0, maxDemandTime: null, dailyCharge: 0 };


            const generalChannel = Object.values(channelTotals).find(c => c.type === 'general');
            if (!generalChannel || !generalChannel.usageData || generalChannel.usageData.length === 0) {
                return { cost: 0, maxDemandKwh: 0, maxDemandTime: null, dailyCharge: 0 };
            }
            
            const demandRate = planConfig ? planConfig.demand.r : (parseFloat(document.getElementById('demandRate').value) || 0);
            const startTime = planConfig ? planConfig.demand.s : document.getElementById('demandWindowStart').value;
            const endTime = planConfig ? planConfig.demand.f : document.getElementById('demandWindowEnd').value;

            const [startHour, startMin] = startTime.split(':').map(Number);
            const [endHour, endMin] = endTime.split(':').map(Number);

            const demandWindowUsage = generalChannel.usageData.filter(item => {
                const d = new Date(item.nemTime);
                const day = d.getDay(); 
                if (!demandDays.includes(day)) return false;

                const hour = d.getHours();
                const min = d.getMinutes();
                
                const timeInMins = hour * 60 + min;
                const startInMins = startHour * 60 + startMin;
                let endInMins = endHour * 60 + endMin;

                if (startInMins > endInMins) { // overnight window
                    return timeInMins >= startInMins || timeInMins < endInMins;
                }
                return timeInMins >= startInMins && timeInMins < endInMins;
            });
            
            if (demandWindowUsage.length === 0) {
                return { cost: 0, maxDemandKwh: 0, maxDemandTime: null, dailyCharge: 0 };
            }

            const thirtyMinChunks = {};
            demandWindowUsage.forEach(item => {
                const itemDate = new Date(item.nemTime);
                const minutes = itemDate.getMinutes();
                itemDate.setSeconds(0, 0);

                if (minutes < 30) {
                    itemDate.setMinutes(0);
                } else {
                    itemDate.setMinutes(30);
                }
                const blockStartTime = itemDate.toISOString();

                if (!thirtyMinChunks[blockStartTime]) {
                    thirtyMinChunks[blockStartTime] = 0;
                }
                thirtyMinChunks[blockStartTime] += (parseFloat(item.kwh) || 0);
            });
            
            let maxDemandKwh = 0;
            let maxDemandTime = null;
            for (const startTime in thirtyMinChunks) {
                if (thirtyMinChunks[startTime] > maxDemandKwh) {
                    maxDemandKwh = thirtyMinChunks[startTime];
                    maxDemandTime = startTime;
                }
            }
            
            if (maxDemandKwh === 0) {
                return { cost: 0, maxDemandKwh: 0, maxDemandTime: null, dailyCharge: 0 };
            }

            let applicableDaysCount = 0;
            let currentDate = new Date(startDateStr + 'T00:00:00');
            const endDate = new Date(endDateStr + 'T00:00:00');
            while (currentDate <= endDate) {
                const day = currentDate.getDay();
                if (demandDays.includes(day)) {
                    applicableDaysCount++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const dailyCharge = (maxDemandKwh * 2) * (demandRate / 100);
            const totalDemandCost = dailyCharge * applicableDaysCount;
            
            return {
                cost: totalDemandCost,
                maxDemandKwh: maxDemandKwh,
                maxDemandTime: maxDemandTime,
                dailyCharge: dailyCharge
            };
        }


        function displayAverageGraph() {
            const averageGraphContainer = document.getElementById('averageGraphContainer');
            
            if (!cachedChannelData) {
                console.error("No data available for graph.");
                averageGraphContainer.innerHTML = '<p class="text-center text-red-500">No data available to render graph.</p>';
                return;
            }
            const generalChannel = Object.values(cachedChannelData).find(c => c.type === 'general');
            const feedInChannel = Object.values(cachedChannelData).find(c => c.type === 'feedIn');
            const controlledLoadChannel = Object.values(cachedChannelData).find(c => c.type === 'controlledLoad');

            if (!generalChannel || !generalChannel.usageData || generalChannel.usageData.length === 0) {
                console.error("No general usage data for graph.");
                 averageGraphContainer.innerHTML = '<p class="text-center text-red-500">No general usage data found to render graph.</p>';
                return;
            }

            const intervals = Array.from({ length: 48 }, () => ({ totalKwh: 0, totalCents: 0, count: 0 }));
            
            const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00');
            const endDate = new Date(document.getElementById('endDate').value + 'T00:00:00');
            const numDays = Math.round((endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24)) + 1;

            generalChannel.usageData.forEach(item => {
                const nemTimeStr = item.nemTime;
                const hours = parseInt(nemTimeStr.substring(11, 13));
                const minutes = parseInt(nemTimeStr.substring(14, 16));
                const intervalIndex = hours * 2 + Math.floor(minutes / 30);
                
                if (intervals[intervalIndex]) {
                    intervals[intervalIndex].totalKwh += (parseFloat(item.kwh) || 0);
                    intervals[intervalIndex].totalCents += (parseFloat(item.perKwh) || 0);
                    intervals[intervalIndex].count += 1;
                }
            });

            const feedInIntervals = Array.from({ length: 48 }, () => ({ totalKwh: 0, totalCents: 0, count: 0 }));
            if (feedInChannel && feedInChannel.usageData) {
                feedInChannel.usageData.forEach(item => {
                    const nemTimeStr = item.nemTime;
                    const hours = parseInt(nemTimeStr.substring(11, 13));
                    const minutes = parseInt(nemTimeStr.substring(14, 16));
                    const intervalIndex = hours * 2 + Math.floor(minutes / 30);
                    
                    if (feedInIntervals[intervalIndex]) {
                        feedInIntervals[intervalIndex].totalKwh += (parseFloat(item.kwh) || 0);
                        feedInIntervals[intervalIndex].totalCents += (parseFloat(item.perKwh) || 0);
                        feedInIntervals[intervalIndex].count += 1;
                    }
                });
            }
            
            const controlledLoadIntervals = Array.from({ length: 48 }, () => ({ totalKwh: 0 }));
            if (controlledLoadChannel && controlledLoadChannel.usageData) {
                controlledLoadChannel.usageData.forEach(item => {
                    const nemTimeStr = item.nemTime;
                    const hours = parseInt(nemTimeStr.substring(11, 13));
                    const minutes = parseInt(nemTimeStr.substring(14, 16));
                    const intervalIndex = hours * 2 + Math.floor(minutes / 30);

                    if (controlledLoadIntervals[intervalIndex]) {
                        controlledLoadIntervals[intervalIndex].totalKwh += (parseFloat(item.kwh) || 0);
                    }
                });
            }

            const labels = [];
            for (let i = 0; i < 48; i++) {
                const hour = Math.floor(i / 2);
                const minute = (i % 2 === 0) ? '00' : '30';
                labels.push(`${hour.toString().padStart(2, '0')}:${minute}`);
            }
            
            const avgUsageData = intervals.map(i => numDays > 0 ? (i.totalKwh / numDays) * 2 : 0);
            const avgFeedInData = feedInIntervals.map(i => numDays > 0 ? (-i.totalKwh / numDays) * 2 : 0);
            const avgControlledLoadData = controlledLoadIntervals.map(i => numDays > 0 ? (i.totalKwh / numDays) * 2 : 0);
            const avgPriceData = intervals.map(i => i.count > 0 ? (i.totalCents / i.count) : 0);
            const avgFeedInPriceData = feedInIntervals.map(i => i.count > 0 ? (-i.totalCents / i.count) : 0);

            const ctx = document.getElementById('usagePriceChart').getContext('2d');
            
            if (usageChart) {
                usageChart.destroy();
            }
            
            const chartDatasets = [];
            
            const avgDailyGeneralKwh = (generalChannel?.totalKWh || 0) / numDays;
            const avgDailyFeedInKwh = (feedInChannel?.totalKWh || 0) / numDays;
            const avgDailyControlledLoadKwh = (controlledLoadChannel?.totalKWh || 0) / numDays;

            const generalAvgPrice = (generalChannel?.totalKWh > 0 ? ((generalChannel.totalAmberCost * 100) / generalChannel.totalKWh) : 0).toFixed(2);
            const feedInAvgPrice = (feedInChannel?.totalKWh > 0 ? ((-feedInChannel.totalAmberCost * 100) / feedInChannel.totalKWh) : 0).toFixed(2);
            const controlledLoadAvgPrice = (controlledLoadChannel?.totalKWh > 0 ? ((controlledLoadChannel.totalAmberCost * 100) / controlledLoadChannel.totalKWh) : 0).toFixed(2);


            if (controlledLoadChannel && (controlledLoadChannel.totalKWh || 0) > 0) {
                chartDatasets.push({
                    label: `Average Controlled Load (kW) - Total: ${avgDailyControlledLoadKwh.toFixed(1)} kWh @ ${controlledLoadAvgPrice} c/kWh`,
                    data: avgControlledLoadData,
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    yAxisID: 'yUsage',
                    order: 2,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                });
            }

            chartDatasets.push({
                label: `Usage (kW) - Total: ${avgDailyGeneralKwh.toFixed(1)} kWh @ ${generalAvgPrice} c/kWh`,
                data: avgUsageData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                yAxisID: 'yUsage',
                order: 2,
                barPercentage: 1.0,
                categoryPercentage: 1.0
            });

            if (feedInChannel && (feedInChannel.totalKWh || 0) > 0) {
                chartDatasets.push({
                    label: `Feed-in (kW) - Total: ${avgDailyFeedInKwh.toFixed(1)} kWh, Price: ${feedInAvgPrice} c/kWh`,
                    data: avgFeedInData,
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    yAxisID: 'yUsage',
                    order: 2,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                });
            }

            chartDatasets.push({
                label: 'Usage (c/kWh)',
                data: avgPriceData,
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                fill: false,
                yAxisID: 'yPrice',
                order: 1
            });

            if (feedInChannel && (feedInChannel.totalKWh || 0) > 0) {
                chartDatasets.push({
                    label: 'Feed-in (c/kWh)',
                    data: avgFeedInPriceData,
                    type: 'line',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    fill: false,
                    yAxisID: 'yPrice',
                    order: 1
                });
            }

            const allUsage = [...avgUsageData, ...avgFeedInData, ...avgControlledLoadData];
            const usageMin = Math.min(...allUsage);
            const usageMax = Math.max(...allUsage);
            const priceMax = Math.max(...avgPriceData.filter(p => p !== null));

            let priceAxisOptions = {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'Average Spot Price (c/kWh)' },
                grid: { drawOnChartArea: false },
            };


            usageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            stacked: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    const label = this.getLabelForValue(value);
                                    if (index % 4 === 0) return label;
                                    const isZoomed = this.chart.getZoomLevel() > 1;
                                    if (index === ticks.length - 1 && !isZoomed) return '24:00';
                                    return '';
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: function(context) {
                                    if (context.index % 2 === 0) {
                                        return 'rgba(0, 0, 0, 0.2)';
                                    }
                                    return 'rgba(0, 0, 0, 0.05)';
                                },
                            }
                        },
                        yUsage: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Average Power (kW)' },
                            stacked: true
                        },
                        yPrice: priceAxisOptions
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Average 24-Hour Usage & Spot Price (${document.getElementById('startDate').value} to ${document.getElementById('endDate').value})`
                        },
                        tooltip: {
                            position: 'cursor',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.yAxisID === 'yPrice') {
                                            label = `Price: ${parseFloat(context.parsed.y).toFixed(2)} c/kWh`;
                                        } else {
                                            label = `Usage: ${parseFloat(context.parsed.y).toFixed(2)} kW`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                drag: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: ({chart}) => {
                                    if (chart.getZoomLevel() > 1) {
                                        document.getElementById('resetAverageZoomBtn').classList.remove('hidden');
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function displayDailyGraph(selectedDateStr) {
             const generalChannel = Object.values(cachedChannelData).find(c => c.type === 'general');
            if (!generalChannel || !generalChannel.usageData || generalChannel.usageData.length === 0) {
                console.error("No general usage data for daily graph.");
                return;
            }

            const dayData = generalChannel.usageData.filter(item => item.nemTime.substring(0, 10) === selectedDateStr);
            
            const intervals = Array.from({ length: 288 }, () => ({ kwh: 0, price: null, count: 0 }));

            dayData.forEach(item => {
                const nemTimeStr = item.nemTime;
                const hours = parseInt(nemTimeStr.substring(11, 13));
                const minutes = parseInt(nemTimeStr.substring(14, 16));
                const intervalIndex = hours * 12 + Math.floor(minutes / 5);
                
                if(intervals[intervalIndex]) {
                    intervals[intervalIndex].kwh += (parseFloat(item.kwh) || 0);
                    intervals[intervalIndex].price = (intervals[intervalIndex].price || 0) + (parseFloat(item.perKwh) || 0);
                    intervals[intervalIndex].count += 1;
                }
            });

            const feedInChannel = Object.values(cachedChannelData).find(c => c.type === 'feedIn');
            const feedInIntervals = Array.from({ length: 288 }, () => ({ kwh: 0, price: 0, count: 0 }));
            if (feedInChannel && feedInChannel.usageData) {
                const dayDataFeedIn = feedInChannel.usageData.filter(item => item.nemTime.substring(0, 10) === selectedDateStr);
                dayDataFeedIn.forEach(item => {
                    const nemTimeStr = item.nemTime;
                    const hours = parseInt(nemTimeStr.substring(11, 13));
                    const minutes = parseInt(nemTimeStr.substring(14, 16));
                    const intervalIndex = hours * 12 + Math.floor(minutes / 5);

                    if (feedInIntervals[intervalIndex]) {
                        feedInIntervals[intervalIndex].kwh += (parseFloat(item.kwh) || 0);
                        feedInIntervals[intervalIndex].price += (parseFloat(item.perKwh) || 0);
                        feedInIntervals[intervalIndex].count += 1;
                    }
                });
            }
            
            const controlledLoadChannel = Object.values(cachedChannelData).find(c => c.type === 'controlledLoad');
            const controlledLoadIntervals = Array.from({ length: 288 }, () => ({ kwh: 0 }));
            if (controlledLoadChannel && controlledLoadChannel.usageData) {
                const dayDataControlled = controlledLoadChannel.usageData.filter(item => item.nemTime.substring(0, 10) === selectedDateStr) || [];
                dayDataControlled.forEach(item => {
                    const nemTimeStr = item.nemTime;
                    const hours = parseInt(nemTimeStr.substring(11, 13));
                    const minutes = parseInt(nemTimeStr.substring(14, 16));
                    const intervalIndex = hours * 12 + Math.floor(minutes / 5);

                    if (controlledLoadIntervals[intervalIndex]) {
                        controlledLoadIntervals[intervalIndex].kwh += (parseFloat(item.kwh) || 0);
                    }
                });
            }

            const labels = intervals.map((_, i) => {
                const hour = Math.floor(i / 12).toString().padStart(2, '0');
                const minute = ((i % 12) * 5).toString().padStart(2, '0');
                return `${hour}:${minute}`;
            });

            const usageData = intervals.map(i => i.kwh * 12);
            const feedInData = feedInIntervals.map(i => -i.kwh * 12);
            const controlledLoadData = controlledLoadIntervals.map(i => i.kwh * 12);
            const priceData = intervals.map(i => i.count > 0 ? i.price / i.count : null);
            const feedInPriceData = feedInIntervals.map(i => i.count > 0 ? -i.price / i.count : null);

            const ctx = document.getElementById('dailyChart').getContext('2d');
            if (dailyUsageChart) {
                dailyUsageChart.destroy();
            }
            
            const chartDatasets = [];

            const dailyGeneralKwh = dayData.reduce((total, item) => total + (parseFloat(item.kwh) || 0), 0);
            const dailyGeneralCost = dayData.reduce((total, item) => total + ((parseFloat(item.perKwh) || 0) / 100) * (parseFloat(item.kwh) || 0), 0);
            const dailyGeneralAvgPrice = (dailyGeneralKwh > 0 ? (dailyGeneralCost / dailyGeneralKwh) * 100 : 0).toFixed(2);
            
            const dayDataFeedIn = feedInChannel?.usageData.filter(item => item.nemTime.substring(0, 10) === selectedDateStr) || [];
            const dailyFeedInKwh = dayDataFeedIn.reduce((total, item) => total + (parseFloat(item.kwh) || 0), 0);
            const dailyFeedInCost = dayDataFeedIn.reduce((total, item) => total + ((parseFloat(item.perKwh) || 0) / 100) * (parseFloat(item.kwh) || 0), 0);
            const dailyFeedInAvgPrice = (dailyFeedInKwh > 0 ? ((-dailyFeedInCost) / dailyFeedInKwh) * 100 : 0).toFixed(2);

            const dayDataControlled = controlledLoadChannel?.usageData.filter(item => item.nemTime.substring(0, 10) === selectedDateStr) || [];
            const dailyControlledLoadKwh = dayDataControlled.reduce((total, item) => total + (parseFloat(item.kwh) || 0), 0);
            const dailyControlledLoadCost = dayDataControlled.reduce((total, item) => total + ((parseFloat(item.perKwh) || 0) / 100) * (parseFloat(item.kwh) || 0), 0);
            const dailyControlledLoadAvgPrice = (dailyControlledLoadKwh > 0 ? (dailyControlledLoadCost / dailyControlledLoadKwh) * 100 : 0).toFixed(2);


            if (controlledLoadChannel && (controlledLoadChannel.totalKWh || 0) > 0) {
                 chartDatasets.push({
                    label: `Controlled Load (kW) - Total: ${dailyControlledLoadKwh.toFixed(1)} kWh @ ${dailyControlledLoadAvgPrice} c/kWh`,
                    data: controlledLoadData,
                    backgroundColor: 'rgba(13, 110, 253, 0.6)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    yAxisID: 'yUsage',
                    order: 2,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                });
            }

            chartDatasets.push({
                label: `Usage (kW) - Total: ${dailyGeneralKwh.toFixed(1)} kWh @ ${dailyGeneralAvgPrice} c/kWh`,
                data: usageData,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                yAxisID: 'yUsage',
                order: 2,
                barPercentage: 1.0,
                categoryPercentage: 1.0
            });

            if (feedInChannel) {
                chartDatasets.push({
                    label: `Feed-in (kW) - Total: ${dailyFeedInKwh.toFixed(1)} kWh @ ${dailyFeedInAvgPrice} c/kWh`,
                    data: feedInData,
                    backgroundColor: 'rgba(40, 167, 69, 0.6)',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    yAxisID: 'yUsage',
                    order: 2,
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                });
            }
            
            chartDatasets.push({
                label: 'Usage (c/kWh)',
                data: priceData,
                type: 'line',
                borderColor: 'rgba(255, 99, 132, 1)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                pointRadius: 0,
                borderWidth: 2,
                fill: false,
                yAxisID: 'yPrice',
                order: 1,
                spanGaps: true,
            });

            if (feedInChannel && (feedInChannel.totalKWh || 0) > 0) {
                chartDatasets.push({
                    label: 'Feed-in Price (c/kWh)',
                    data: feedInPriceData,
                    type: 'line',
                    borderColor: 'rgba(40, 167, 69, 1)',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)',
                    pointRadius: 0,
                    borderWidth: 2,
                    fill: false,
                    yAxisID: 'yPrice',
                    order: 1,
                    spanGaps: true,
                });
            }
            
            const allUsage = [...usageData, ...feedInData, ...controlledLoadData];
            const usageMin = Math.min(...allUsage);
            const usageMax = Math.max(...allUsage);
            const priceMax = Math.max(...priceData.filter(p => p !== null));

            let priceAxisOptions = {
                type: 'linear',
                display: true,
                position: 'right',
                title: { display: true, text: 'Spot Price (c/kWh)' },
                grid: { drawOnChartArea: false },
            };


            dailyUsageChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { 
                            stacked: true,
                            ticks: {
                                callback: function(value, index, ticks) {
                                    const label = this.getLabelForValue(value);
                                    if (index % 24 === 0) return label;
                                    const isZoomed = this.chart.getZoomLevel() > 1;
                                    if (index === ticks.length - 1 && !isZoomed) return '24:00';
                                    return '';
                                },
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: function(context) {
                                    if (context.index % 12 === 0) { 
                                        return 'rgba(0, 0, 0, 0.2)';
                                    }
                                     if (context.index % 6 === 0) { 
                                        return 'rgba(0, 0, 0, 0.05)';
                                    }
                                    return 'transparent';
                                },
                            }
                        },
                        yUsage: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Power (kW)' },
                            stacked: true,
                        },
                        yPrice: priceAxisOptions
                    },
                    plugins: {
                        title: { display: true, text: `Usage & Spot Price for ${selectedDateStr}` },
                        tooltip: {
                            position: 'cursor',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.yAxisID === 'yPrice') {
                                            label = `Price: ${parseFloat(context.parsed.y).toFixed(2)} c/kWh`;
                                        } else {
                                            label = `Usage: ${parseFloat(context.parsed.y).toFixed(2)} kW`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                drag: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: ({chart}) => {
                                    if (chart.getZoomLevel() > 1) {
                                        document.getElementById('resetDailyZoomBtn').classList.remove('hidden');
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        async function displayResults(channelTotals, overallAmberCost, overallOtherCost, startDateStr, endDateStr, numDays, demandTariffInfo, otherDemandTariffInfo) {
            lastResultDataPayload = { channelTotals, overallAmberCost, overallOtherCost, startDateStr, endDateStr, numDays, demandTariffInfo, otherDemandTariffInfo };

            const resultsTableContainer = document.getElementById('results-table-container');
            const downloadCsvButton = document.getElementById('downloadCsvButton');
            const averageGraphContainer = document.getElementById('averageGraphContainer');
            const dailyGraphSection = document.getElementById('dailyGraphSection');

            const planName = document.getElementById('planName').value.trim() || 'Other Supplier';
            const period = `(${startDateStr} to ${endDateStr})`;

            // Recalculate totals with potential GST adjustment
            let adjustedAmberTotal = 0;
            let adjustedOtherTotal = 0;
            
            let tableHTML = `
                <p class="text-sm text-gray-500 mb-4">Period: ${numDays} days ${period}</p>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Channel</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Usage (kWh)</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amber</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">${planName}</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            Object.values(channelTotals).forEach(c => {
                if (c.totalKWh === 0 && c.totalAmberCost === 0 && c.totalOtherCost === 0) {
                    return;
                }
                const isFeedIn = c.type === 'feedIn';
                const adjustedAmberCost = adjustForGst(c.totalAmberCost || 0, isFeedIn);
                const adjustedOtherCost = adjustForGst(c.totalOtherCost || 0, isFeedIn);

                adjustedAmberTotal += adjustedAmberCost;
                adjustedOtherTotal += adjustedOtherCost;

                const totalKWhText = (c.totalKWh || 0).toFixed(1);
                const totalAmberCostText = adjustedAmberCost.toFixed(2);
                const totalOtherCostText = adjustedOtherCost.toFixed(2);
                tableHTML += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${c.identifier}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${c.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${totalKWhText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">$${totalAmberCostText}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">$${totalOtherCostText}</td>
                    </tr>
                `;
            });
            
            if (demandTariffInfo && demandTariffInfo.cost > 0) {
                const adjustedDemandCost = adjustForGst(demandTariffInfo.cost || 0);
                adjustedAmberTotal += adjustedDemandCost;
                const maxDemandKw = ((demandTariffInfo.maxDemandKwh || 0) * 2).toFixed(2);
                const maxDemandDateTime = new Date(demandTariffInfo.maxDemandTime).toLocaleString('en-AU', { dateStyle: 'short', timeStyle: 'short' });
                
                tableHTML += `
                    <tr class="font-semibold border-t">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" colspan="2">Amber Demand Tariff</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                            <div class="text-xs">Max: ${maxDemandKw} kW</div>
                            <div class="text-xs text-blue-600 font-normal">on ${maxDemandDateTime}</div>                            
                            <div class="text-xs">X ${demandTariffInfo.demandDays} days</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedDemandCost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"></td>
                    </tr>
                `;
            }
            
             if (otherDemandTariffInfo && otherDemandTariffInfo.cost > 0) {
                const adjustedOtherDemandCost = adjustForGst(otherDemandTariffInfo.cost || 0);
                adjustedOtherTotal += adjustedOtherDemandCost;
                const maxDemandKw = ((otherDemandTariffInfo.maxDemandKwh || 0) * 2).toFixed(2);
                const maxDemandDateTime = new Date(otherDemandTariffInfo.maxDemandTime).toLocaleString('en-AU', { dateStyle: 'short', timeStyle: 'short' });
                
                tableHTML += `
                    <tr class="font-semibold border-t">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" colspan="2">${planName} Demand Tariff</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                            <div class="text-xs">Max: ${maxDemandKw} kW</div>
                            <div class="text-xs text-blue-600 font-normal">on ${maxDemandDateTime}</div>                            
                            <div class="text-xs">X ${numDays} days</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">$${adjustedOtherDemandCost.toFixed(2)}</td>
                    </tr>
                `;
            }

            const amberConnectionCost = (AMBER_CONNECTION_COST_PER_DAY_CENTS * numDays / 100);
            const otherDailyConnection = (parseFloat(document.getElementById('dailyConnectionRate').value) || 0) * numDays / 100;
            const amberSubscriptionCost = (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS * numDays / 100);

            const adjustedAmberConnectionCost = adjustForGst(amberConnectionCost);
            const adjustedOtherDailyConnection = adjustForGst(otherDailyConnection);
            const adjustedAmberSubscriptionCost = adjustForGst(amberSubscriptionCost);

            adjustedAmberTotal += adjustedAmberConnectionCost + adjustedAmberSubscriptionCost;
            adjustedOtherTotal += adjustedOtherDailyConnection;

            tableHTML += `
                <tr class="font-semibold border-t">
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900" colspan="3">Daily Connection</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedAmberConnectionCost.toFixed(2)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedOtherDailyConnection.toFixed(2)}</td>
                </tr>
                <tr class="font-semibold">
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900" colspan="3">Amber Subscription</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedAmberSubscriptionCost.toFixed(2)}</td>
                    <td class="px-6 py-2 whitespace-nowrap text-sm text-gray-900 text-right">N/A</td>
                </tr>
            `;

             tableHTML += `
                    <tr class="bg-gray-50 font-bold">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" colspan="3">Total</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedAmberTotal.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">$${adjustedOtherTotal.toFixed(2)}</td>
                    </tr>
                </tbody>
                </table>
            `;
            
            const savings = adjustedOtherTotal - adjustedAmberTotal;
            const percentSave = savings / adjustedOtherTotal * 100 
            let savingsSummaryHTML = '<div class="mt-6 p-4 rounded-lg text-center ';
            if (savings > 0) {
                savingsSummaryHTML += 'bg-green-100">';
                savingsSummaryHTML += `<p class="text-lg font-medium text-green-800">Amber saved you <span class="font-bold">$${savings.toFixed(2)} \(${percentSave.toFixed(1)}\%\)</span> compared to <span class="italic">${planName}</span>!</p>`;
            } else {
                 savingsSummaryHTML += 'bg-red-100">';
                 savingsSummaryHTML += `<p class="text-lg font-medium text-red-800">It would have been <span class="font-bold">$${Math.abs(savings).toFixed(2)}</span> cheaper with <span class="italic">${planName}</span>.</p>`;
            }
            savingsSummaryHTML += '</div>';

            resultsTableContainer.innerHTML = tableHTML + savingsSummaryHTML;
            
            downloadCsvButton.disabled = false;

            // Do not re-render graphs on GST toggle.
            if (!usageChart) {
                averageGraphContainer.classList.remove('hidden');
                displayAverageGraph();
                document.getElementById('resetAverageZoomBtn').addEventListener('click', () => {
                    if (usageChart) {
                        document.getElementById('resetAverageZoomBtn').classList.add('hidden');
                        usageChart.resetZoom();
                    }
                });
            }
            
            if (!dailyUsageChart) {
                dailyGraphSection.classList.remove('hidden');
                const daySelector = document.getElementById('daySelector');
                const prevDayBtn = document.getElementById('prevDayBtn');
                const nextDayBtn = document.getElementById('nextDayBtn');

                daySelector.innerHTML = '';

                const start = new Date(startDateStr + 'T00:00:00');
                const end = new Date(endDateStr + 'T00:00:00');
                let currentDate = new Date(start);
                const datesArray = []; // Use an array to collect and reverse dates

                while (currentDate <= end) {
                    datesArray.push(formatForInput(currentDate));
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // --- MODIFICATION HERE: Reverse the array to put the most recent date first ---
                datesArray.reverse();
                
                datesArray.forEach(dateValue => {
                    const option = document.createElement('option');
                    option.value = dateValue;
                    option.textContent = dateValue;
                    daySelector.appendChild(option);
                });

                daySelector.onchange = () => {
                    displayDailyGraph(daySelector.value);
                    updateNavButtons();
                };

                prevDayBtn.onclick = () => {
                    if (daySelector.selectedIndex > 0) {
                        daySelector.selectedIndex--;
                        daySelector.dispatchEvent(new Event('change'));
                    }
                };

                nextDayBtn.onclick = () => {
                    if (daySelector.selectedIndex < daySelector.options.length - 1) {
                        daySelector.selectedIndex++;
                        daySelector.dispatchEvent(new Event('change'));
                    }
                };

                function updateNavButtons() {
                    prevDayBtn.disabled = daySelector.selectedIndex === 0;
                    nextDayBtn.disabled = daySelector.selectedIndex === daySelector.options.length - 1;
                }

                if (daySelector.options.length > 0) {
                    daySelector.dispatchEvent(new Event('change'));
                }

                document.getElementById('resetDailyZoomBtn').addEventListener('click', () => {
                    if (dailyUsageChart) {
                        document.getElementById('resetDailyZoomBtn').classList.add('hidden');
                        dailyUsageChart.resetZoom();
                    }
                });
            }
            
            await displayCalendar();
            
            setTimeout(() => {
                const startDateValue = document.getElementById('startDate').value;
                if (startDateValue) {
                    const calendarContainer = document.getElementById('calendar-container');
                    const startMonthKey = startDateValue.substring(0, 7); // e.g., "2025-10"
                    const targetMonthHeader = document.querySelector(`#calendar-container [data-month-key="${startMonthKey}"]`);
                    
                    if (calendarContainer && targetMonthHeader) {
                        // Set the container's scroll position to the top of the target month
                        calendarContainer.scrollTop = targetMonthHeader.offsetTop;
                    }
                }
            }, 0);
            
            updatePlanSavings();
        }

        // --- Calendar & Tooltip Functions ---

        function updatePlanSavings() {
            if (!lastResultDataPayload) {
                const planSelector = document.getElementById('planSelector');
                for (const option of planSelector.options) {
                    if (option.value) {
                        option.textContent = option.value;
                    } else {
                        option.textContent = "-- Custom --";
                    }
                }
                return;
            }

            const state = document.getElementById('stateSelector').value;
            const planSelector = document.getElementById('planSelector');
            const originalSelectedPlanValue = planSelector.value;
            const baselineCost = amberCostBaseline;

            const originalSaveAllSettings = window.saveAllSettings;
            window.saveAllSettings = () => {};

            try {
                for (const option of planSelector.options) {
                    const planValue = option.value;
                    const planText = (planValue === "") ? "-- Custom --" : planValue;

                    if (planValue === "") {
                        option.textContent = planText;
                        continue;
                    }

                    planSelector.value = planValue;
                    applyPlanTemplate();

                    const planConfig = createPlanObjectFromForm();

                    const tempChannelTotals = JSON.parse(JSON.stringify(lastResultDataPayload.channelTotals));
                    const otherDemandInfo = calculateOtherDemandTariff(tempChannelTotals, lastResultDataPayload.startDateStr, lastResultDataPayload.endDateStr, planConfig);
                    calculateOtherSupplierCosts(tempChannelTotals, otherDemandInfo ? otherDemandInfo.cost : 0, planConfig);

                    let currentPlanTotalCost = 0;
                    Object.values(tempChannelTotals).forEach(c => {
                        const isFeedIn = c.type === 'feedIn';
                        currentPlanTotalCost += adjustForGst(c.totalOtherCost || 0, isFeedIn);
                    });

                    const otherDailyConnection = (parseFloat(document.getElementById('dailyConnectionRate').value) || 0) * lastResultDataPayload.numDays / 100;
                    currentPlanTotalCost += adjustForGst(otherDailyConnection);

                    const difference = baselineCost - currentPlanTotalCost;
                    let savingsText = '';

                    if (Math.abs(difference) < 0.01) {
                        savingsText = ' (~ no difference)';
                    } else if (difference > 0) {
                        savingsText = ` ($${difference.toFixed(2)} cheaper)`;
                    } else {
                        savingsText = ` ($${Math.abs(difference).toFixed(2)} more)`;
                    }
                    option.textContent = planValue + savingsText;
                }
            } finally {
                planSelector.value = originalSelectedPlanValue;
                applyPlanTemplate();
                window.saveAllSettings = originalSaveAllSettings;
            }
        }

        function precalculateDailySummaries(channelData) {
            const summaries = {};
            const monthlyDemandInfo = {};

            // Step 1: Initialize summaries object and calculate base costs (no change)
            const allDatesWithData = new Set();
            Object.values(channelData).forEach(channel => {
                channel.usageData.forEach(item => {
                    allDatesWithData.add(item.nemTime.substring(0, 10));
                });
            });

            const sortedDates = [...allDatesWithData].sort();
            if (sortedDates.length > 0) {
                const start = new Date(sortedDates[0]);
                const end = new Date(sortedDates[sortedDates.length - 1]);
                let loopDate = new Date(start);
                while (loopDate <= end) {
                    const dateStr = formatForInput(loopDate);
                    summaries[dateStr] = {
                        totalInKwh: 0, totalOutKwh: 0,
                        amberCost: 0, otherCost: 0,
                        amberDemandCost: 0, otherDemandCost: 0,
                        channels: {}
                    };
                    loopDate.setDate(loopDate.getDate() + 1);
                }
            }

            const getOtherRateForItem = (item, type) => {
                const rateType = document.querySelector('input[name="rateType"]:checked').value;
                if (rateType === 'flat') {
                    if(type === 'feedIn') return parseFloat(document.getElementById('otherSupplierFeedInRateFlat').value) || 0;
                    return parseFloat(document.getElementById('otherSupplierRate').value) || 0;
                } else { // tou
                    const touConfig = JSON.parse(localStorage.getItem('touConfig') || '{}');
                    if(type === 'feedIn') return parseFloat(touConfig.feedIn) || 0;
                    if(type === 'controlledLoad') return parseFloat(touConfig.controlledLoad) || 0;
                    
                    const fallbackRate = parseFloat(document.getElementById('otherSupplierRate').value) || 0;
                    return getTouRate(new Date(item.nemTime), touConfig, fallbackRate);
                }
            };

            Object.values(channelData).forEach(channel => {
                channel.usageData.forEach(item => {
                    const dateStr = item.nemTime.substring(0, 10);
                    if (!summaries[dateStr]) return; 

                    const kwh = parseFloat(item.kwh) || 0;
                    const perKwh = parseFloat(item.perKwh) || 0;
                    const amberItemCost = (kwh * perKwh) / 100;
                    const otherRate = getOtherRateForItem(item, channel.type);
                    const otherItemCost = (kwh * otherRate) / 100;

                    if (!summaries[dateStr].channels[channel.identifier]) {
                        summaries[dateStr].channels[channel.identifier] = { type: channel.type, kwh: 0, amberCost: 0, otherCost: 0 };
                    }

                    summaries[dateStr].channels[channel.identifier].kwh += kwh;
                    summaries[dateStr].channels[channel.identifier].amberCost += amberItemCost;
                    
                    summaries[dateStr].amberCost += amberItemCost;

                    if (channel.type === 'feedIn') {
                        summaries[dateStr].totalOutKwh += kwh;
                        summaries[dateStr].otherCost -= otherItemCost;
                        summaries[dateStr].channels[channel.identifier].otherCost -= otherItemCost;
                    } else {
                        summaries[dateStr].totalInKwh += kwh;
                        summaries[dateStr].otherCost += otherItemCost;
                        summaries[dateStr].channels[channel.identifier].otherCost += otherItemCost;
                    }
                });
            });
            
            // Step 2: Group all data by month
            const monthlyData = {};
            Object.keys(channelData).forEach(channelId => {
                channelData[channelId].usageData.forEach(item => {
                    const monthKey = item.nemTime.substring(0, 7); // "YYYY-MM"
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {};
                    }
                    if (!monthlyData[monthKey][channelId]) {
                        monthlyData[monthKey][channelId] = {
                            identifier: channelData[channelId].identifier,
                            type: channelData[channelId].type,
                            usageData: []
                        };
                    }
                    monthlyData[monthKey][channelId].usageData.push(item);
                });
            });

            // Step 3: Iterate through each month and calculate/apply demand charges
            const demandSettings = JSON.parse(localStorage.getItem('demandSettings') || '{}');

            for (const monthKey in monthlyData) {
                const monthChannelData = monthlyData[monthKey];
                
                const year = parseInt(monthKey.substring(0, 4));
                const month = parseInt(monthKey.substring(5, 7)) - 1;
                
                const monthStartDate = new Date(year, month, 1);
                const monthEndDate = new Date(year, month + 1, 0);
                const monthStartDateStr = formatForInput(monthStartDate);
                const monthEndDateStr = formatForInput(monthEndDate);

                // Calculate demand info for this specific month
                const amberDemandInfoMonth = calculateDemandTariff(monthChannelData);
                const otherDemandInfoMonth = calculateOtherDemandTariff(monthChannelData, monthStartDateStr, monthEndDateStr);
                
                monthlyDemandInfo[monthKey] = {
                    amber: amberDemandInfoMonth,
                    other: otherDemandInfoMonth
                };

                const amberDailyDemandCost = (amberDemandInfoMonth && amberDemandInfoMonth.demandDays > 0) ? (amberDemandInfoMonth.cost / amberDemandInfoMonth.demandDays) : 0;
                const otherDailyDemandCharge = (otherDemandInfoMonth) ? otherDemandInfoMonth.dailyCharge : 0;
                
                const amberDemandDaysInMonth = new Set();
                const generalChannelForMonth = Object.values(monthChannelData).find(c => c.type === 'general');
                if (generalChannelForMonth) {
                    generalChannelForMonth.usageData.forEach(item => {
                        if (item.tariffInformation && item.tariffInformation.demandWindow) {
                            amberDemandDaysInMonth.add(item.nemTime.substring(0, 10));
                        }
                    });
                }

                let loopDate = new Date(monthStartDate);
                while(loopDate <= monthEndDate) {
                    const dateStr = formatForInput(loopDate);
                    if (summaries[dateStr]) {
                        if (amberDemandDaysInMonth.has(dateStr)) {
                            summaries[dateStr].amberDemandCost = amberDailyDemandCost;
                        }
                        
                        const dayOfWeek = loopDate.getDay();
                        if ((demandSettings.days || []).includes(dayOfWeek)) {
                            summaries[dateStr].otherDemandCost = otherDailyDemandCharge;
                        }
                    }
                    loopDate.setDate(loopDate.getDate() + 1);
                }
            }
            return { summaries, monthlyDemandInfo };
        }

        async function displayCalendar() {
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            container.className = 'relative space-y-6 max-h-[80vh] overflow-y-auto pr-2';

            const availableDateSet = new Set(Object.keys(dailySummaries));
            
            const selectedDateSet = new Set();
            const startDateValue = document.getElementById('startDate').value;
            const endDateValue = document.getElementById('endDate').value;
            if(startDateValue && endDateValue){
                let d = new Date(startDateValue + 'T00:00:00');
                const endD = new Date(endDateValue + 'T00:00:00');
                while (d <= endD) {
                    selectedDateSet.add(formatForInput(d));
                    d.setDate(d.getDate() + 1);
                }
            }

            const allDates = [...availableDateSet].sort();
            
            if (allDates.length === 0) {
                 if (currentSiteId) container.innerHTML = '<p class="text-center text-gray-500">No data available to display.</p>';
                 return;
            }

            const startDateStr = allDates[0];
            const endDateStr = allDates[allDates.length - 1];
            
            const start = new Date(startDateStr + 'T00:00:00');
            const end = new Date(endDateStr + 'T00:00:00');
            
            let currentMonth = -1;
            let monthGrid;

            const allMonthlyTotals = {};
            for (const dateStr in dailySummaries) {
                const summary = dailySummaries[dateStr];
                if (summary) {
                    const monthKey = dateStr.substring(0, 7);
                    if (!allMonthlyTotals[monthKey]) {
                        allMonthlyTotals[monthKey] = { amber: 0, other: 0, inKwh: 0, outKwh: 0 };
                    }
                    const totalAmberCost = summary.amberCost + (summary.amberDemandCost || 0) + (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                    const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
                    const totalOtherCharges = summary.otherCost + (summary.otherDemandCost || 0) + (otherDailyConnection / 100);
                    
                    allMonthlyTotals[monthKey].amber += totalAmberCost;
                    allMonthlyTotals[monthKey].other += totalOtherCharges;
                    allMonthlyTotals[monthKey].inKwh += summary.totalInKwh;
                    allMonthlyTotals[monthKey].outKwh += summary.totalOutKwh;
                }
            }

            let date = new Date(start.getFullYear(), start.getMonth(), 1);
            const lastDay = new Date(end.getFullYear(), end.getMonth() + 1, 0);

            while(date <= lastDay) {
                const month = date.getMonth();
                const year = date.getFullYear();

                if (month !== currentMonth) {
                    currentMonth = month;
                    const monthName = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                    const monthKey = `${year}-${(month + 1).toString().padStart(2, '0')}`;
                    
                    let summaryHtml = '';
                    if (allMonthlyTotals[monthKey]) {
                        const totals = allMonthlyTotals[monthKey];
                        const savings = totals.other - totals.amber;
                        const savingsColor = savings > 0 ? 'text-green-700' : 'text-red-700';
                        summaryHtml = `
                            <div class="text-sm font-normal text-gray-600 flex items-center space-x-4 flex-wrap">
                                <span>
                                  <span class="text-blue-600">↓${totals.inKwh.toFixed(1)}</span><span class="text-gray-400">/</span><span class="text-green-700">↑${totals.outKwh.toFixed(1)}</span>
                                </span>
                                <span><strong>Amber:</strong> $${totals.amber.toFixed(2)}</span>
                                <span><strong>Other:</strong> $${totals.other.toFixed(2)}</span>
                                <span class="${savingsColor}"><strong>Saving:</strong> $${savings.toFixed(2)}</span>
                            </div>`;
                    }

                    const monthContainer = document.createElement('div');
                    monthContainer.innerHTML = `
                        <div class="flex justify-between items-center mb-2 flex-wrap">
                            <h3 class="text-lg font-bold text-gray-800 mr-4 cursor-pointer hover:underline" data-month-key="${monthKey}">${monthName}</h3>
                            ${summaryHtml}
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center font-semibold mb-1 text-sm text-gray-500">
                            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                        </div>
                    `;
                    monthGrid = document.createElement('div');
                    monthGrid.className = 'grid grid-cols-7 gap-2';
                    monthContainer.appendChild(monthGrid);
                    container.appendChild(monthContainer);

                    const monthHeader = monthContainer.querySelector('h3');
                    monthHeader.addEventListener('mouseenter', (e) => showMonthTooltip(e.currentTarget));
                    monthHeader.addEventListener('mouseleave', hideTooltip);

                    const firstDayOfMonth = new Date(year, month, 1);
                    const startingDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7; // Monday is 0
                    for (let i = 0; i < startingDayOfWeek; i++) {
                        monthGrid.insertAdjacentHTML('beforeend', '<div class="bg-gray-50 rounded-md"></div>');
                    }
                }

                const dateStr = formatForInput(date);
                const day = date.getDate();
                let dayHtml;

                if (availableDateSet.has(dateStr)) {
                    const summary = dailySummaries[dateStr];
                    const isSelected = selectedDateSet.has(dateStr);
                    const borderClass = isSelected ? 'border-4 border-indigo-500' : 'border border-gray-200';
                    
                    if (summary && (summary.totalInKwh > 0 || summary.totalOutKwh > 0)) {
                        const totalAmberCost = summary.amberCost + (summary.amberDemandCost || 0) + (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
                        const costColor = totalAmberCost > 0 ? 'text-red-600' : 'text-green-600';
                        dayHtml = `
                            <div class="calendar-day has-data ${borderClass} rounded-md p-2 flex flex-col hover:bg-indigo-50 shadow-sm" data-date="${dateStr}">
                                <div class="font-bold text-gray-800">${day}</div>
                                <div class="text-xs mt-1 whitespace-nowrap">
                                    <span class="text-blue-600">↓${summary.totalInKwh.toFixed(1)}</span><span class="text-gray-400">/</span><span class="text-green-700">↑${summary.totalOutKwh.toFixed(1)}</span>
                                </div>
                                <div class="text-sm mt-auto font-semibold ${costColor}">
                                    $${totalAmberCost.toFixed(2)}
                                </div>
                            </div>
                        `;
                    } else { 
                        dayHtml = `<div class="calendar-day has-data ${borderClass} bg-gray-50 rounded-md p-2 flex flex-col justify-center items-center" data-date="${dateStr}"><div class="font-bold text-gray-800">${day}</div><div class="text-xs mt-1 text-center text-gray-500 leading-tight">No Usage</div></div>`;
                    }
                } else {
                     dayHtml = `<div class="bg-gray-100 border border-gray-200 rounded-md p-2 flex items-center justify-center"><span class="text-gray-400">${day}</span></div>`;
                }
                monthGrid.insertAdjacentHTML('beforeend', dayHtml);
                date.setDate(date.getDate() + 1);
            }
            
            container.querySelectorAll('.has-data').forEach(cell => {
                cell.addEventListener('mouseenter', (e) => showTooltip(e.currentTarget));
                cell.addEventListener('mouseleave', hideTooltip);
            });
        }
        
        function positionTooltip(tooltip, cell) {
            document.body.appendChild(tooltip);
            const cellRect = cell.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            let top = cellRect.top + window.scrollY - (tooltipRect.height / 2) + (cellRect.height / 2);
            let left = cellRect.right + window.scrollX + 10;

            if (left + tooltipRect.width > window.innerWidth) {
                left = cellRect.left + window.scrollX - tooltipRect.width - 10;
            }
             if (top < window.scrollY) {
                top = window.scrollY + 10;
            }
            if (top + tooltipRect.height > window.scrollY + window.innerHeight) {
                top = window.scrollY + window.innerHeight - tooltipRect.height - 10;
            }

            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
        }

        async function showTooltip(cell) {
            hideTooltip(); 
            const dateStr = cell.dataset.date;
            const monthKey = dateStr.substring(0, 7);
            const summary = dailySummaries[dateStr];

            const tooltip = document.createElement('div');
            tooltip.id = 'day-tooltip';
            tooltip.className = 'absolute bg-white rounded-lg shadow-xl p-4 border border-gray-200 z-10 w-auto';

            if (!summary) {
                tooltip.innerHTML = `<h3 class="text-base font-bold text-gray-800 mb-2">Summary for ${dateStr}</h3><p class="text-xs text-red-500">Could not load summary data.</p>`;
                positionTooltip(tooltip, cell);
                return;
            }
            
            const monthDemandInfo = demandInfoForTooltip ? demandInfoForTooltip[monthKey] : null;
            const planName = document.getElementById('planName').value.trim() || 'Other Supplier';
            const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
            
            const amberDemandCost = summary.amberDemandCost || 0;
            const otherDemandCost = summary.otherDemandCost || 0;

            const totalAmberCharges = summary.amberCost + amberDemandCost + (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100) + (AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100);
            const totalOtherCharges = summary.otherCost + otherDemandCost + (otherDailyConnection / 100);

            let contentHtml = `<h3 class="text-base font-bold text-gray-800 mb-2">Summary for ${dateStr}</h3>`;
            contentHtml += `<table class="min-w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1 text-left font-medium text-gray-500">Channel</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">Usage</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">Amber</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">${planName}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">`;
            
            Object.entries(summary.channels).forEach(([id, data]) => {
                if (Math.abs(data.amberCost) > 0.001 || Math.abs(data.otherCost) > 0.001) {
                    contentHtml += `<tr>
                                        <td class="px-2 py-1 whitespace-nowrap">${id} (${data.type})</td>
                                        <td class="px-2 py-1 text-right">${data.kwh.toFixed(1)} kWh</td>
                                        <td class="px-2 py-1 text-right">$${data.amberCost.toFixed(2)}</td>
                                        <td class="px-2 py-1 text-right">$${data.otherCost.toFixed(2)}</td>
                                    </tr>`;
                }
            });
            contentHtml += `<tr class="border-t"></tr>`;

            const amberDaily = (AMBER_CONNECTION_COST_PER_DAY_CENTS + AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS) / 100;
            const otherDaily = otherDailyConnection / 100;
            let hasDemandRow = false;

            if (monthDemandInfo && monthDemandInfo.amber && monthDemandInfo.amber.cost > 0 && amberDemandCost > 0) {
                 const maxDemandKw = (monthDemandInfo.amber.maxDemandKwh * 2).toFixed(2);
                 contentHtml += `<tr>
                                    <td class="px-2 py-1 text-sm" colspan="2">Amber Demand Tariff <span class="font-normal text-gray-500 text-[10px]">(${maxDemandKw}kW peak)</span></td>
                                    <td class="px-2 py-1 text-right font-semibold">$${amberDemandCost.toFixed(2)}</td>
                                    <td class="px-2 py-1 text-right"></td>
                                </tr>`;
                hasDemandRow = true;
            }

            if (monthDemandInfo && monthDemandInfo.other && monthDemandInfo.other.cost > 0 && otherDemandCost > 0) {
                const maxDemandKw = (monthDemandInfo.other.maxDemandKwh * 2).toFixed(2);
                contentHtml += `<tr>
                                    <td class="px-2 py-1 text-sm" colspan="2">${planName} Demand Tariff <span class="font-normal text-gray-500 text-[10px]">(${maxDemandKw}kW peak)</span></td>
                                    <td class="px-2 py-1 text-right"></td>
                                    <td class="px-2 py-1 text-right font-semibold">$${otherDemandCost.toFixed(2)}</td>
                                </tr>`;
                hasDemandRow = true;
            }

            if (Math.abs(amberDaily) > 0.001 || Math.abs(otherDaily) > 0.001) {
                 contentHtml += `<tr class="${hasDemandRow ? '' : 'border-t'}"> 
                                    <td class="px-2 py-1 font-semibold" colspan="2">Daily Charges</td>
                                    <td class="px-2 py-1 text-right font-semibold">$${amberDaily.toFixed(2)}</td>
                                    <td class="px-2 py-1 text-right font-semibold">$${otherDaily.toFixed(2)}</td>
                                </tr>`;
            }

            contentHtml += `<tr class="bg-gray-50 font-bold">
                                <td class="px-2 py-1" colspan="2">Total</td>
                                <td class="px-2 py-1 text-right">$${totalAmberCharges.toFixed(2)}</td>
                                <td class="px-2 py-1 text-right">$${totalOtherCharges.toFixed(2)}</td>
                            </tr>`;

            contentHtml += `</tbody></table>`;
            
            tooltip.innerHTML = contentHtml;
            positionTooltip(tooltip, cell);
        }

        async function showMonthTooltip(element) {
            hideTooltip();
            const monthKey = element.dataset.monthKey;

            const monthlySummary = {
                totalInKwh: 0,
                totalOutKwh: 0,
                amberCost: 0,
                otherCost: 0,
                amberDemandCost: 0,
                otherDemandCost: 0,
                channels: {},
                daysInMonth: 0
            };

            const datesInMonth = Object.keys(dailySummaries).filter(d => d.startsWith(monthKey));

            for (const dateStr of datesInMonth) {
                const summary = dailySummaries[dateStr];
                if (summary) {
                    monthlySummary.daysInMonth++;
                    monthlySummary.totalInKwh += summary.totalInKwh;
                    monthlySummary.totalOutKwh += summary.totalOutKwh;
                    monthlySummary.amberCost += summary.amberCost;
                    monthlySummary.otherCost += summary.otherCost;
                    monthlySummary.amberDemandCost += (summary.amberDemandCost || 0);
                    monthlySummary.otherDemandCost += (summary.otherDemandCost || 0);

                    Object.entries(summary.channels).forEach(([id, data]) => {
                        if (!monthlySummary.channels[id]) {
                            monthlySummary.channels[id] = { type: data.type, kwh: 0, amberCost: 0, otherCost: 0 };
                        }
                        monthlySummary.channels[id].kwh += data.kwh;
                        monthlySummary.channels[id].amberCost += data.amberCost;
                        monthlySummary.channels[id].otherCost += data.otherCost;
                    });
                }
            }

            if (monthlySummary.daysInMonth === 0) return;

            const tooltip = document.createElement('div');
            tooltip.id = 'day-tooltip';
            tooltip.className = 'absolute bg-white rounded-lg shadow-xl p-4 border border-gray-200 z-10 w-auto';

            const monthDate = new Date(monthKey + '-02T00:00:00');
            const monthName = monthDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            const planName = document.getElementById('planName').value.trim() || 'Other Supplier';
            const otherDailyConnection = parseFloat(document.getElementById('dailyConnectionRate').value) || 0;
            const monthDemandInfo = demandInfoForTooltip ? demandInfoForTooltip[monthKey] : null;

            const amberDemandCost = monthlySummary.amberDemandCost;
            const otherDemandCost = monthlySummary.otherDemandCost;

            const totalAmberDailyCharges = (AMBER_CONNECTION_COST_PER_DAY_CENTS / 100 + AMBER_SUBSCRIPTION_COST_PER_DAY_CENTS / 100) * monthlySummary.daysInMonth;
            const totalOtherDailyCharges = (otherDailyConnection / 100) * monthlySummary.daysInMonth;

            const totalAmberCharges = monthlySummary.amberCost + amberDemandCost + totalAmberDailyCharges;
            const totalOtherCharges = monthlySummary.otherCost + otherDemandCost + totalOtherDailyCharges;


            let contentHtml = `<h3 class="text-base font-bold text-gray-800 mb-2">Summary for ${monthName}</h3>`;
            contentHtml += `<table class="min-w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1 text-left font-medium text-gray-500">Channel</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">Usage</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">Amber</th>
                                        <th class="px-2 py-1 text-right font-medium text-gray-500">${planName}</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">`;

            const theChannels = Object.entries(monthlySummary.channels);

            theChannels.forEach(([id, data]) => {
                if (Math.abs(data.kwh) > 0.01) {
                    contentHtml += `<tr>
                                        <td class="px-2 py-1 whitespace-nowrap">${id} (${data.type})</td>
                                        <td class="px-2 py-1 text-right">${data.kwh.toFixed(1)} kWh</td>
                                        <td class="px-2 py-1 text-right">$${data.amberCost.toFixed(2)}</td>
                                        <td class="px-2 py-1 text-right">$${data.otherCost.toFixed(2)}</td>
                                    </tr>`;
                }
            });
            contentHtml += `<tr class="border-t"></tr>`;

            let hasDemandRow = false;

            if (monthDemandInfo && monthDemandInfo.amber && monthDemandInfo.amber.cost > 0) {
                 const maxDemandKw = (monthDemandInfo.amber.maxDemandKwh * 2).toFixed(2);
                 contentHtml += `<tr>
                                    <td class="px-2 py-1 text-sm" colspan="2">Amber Demand Tariff <span class="font-normal text-gray-500 text-[10px]">(${maxDemandKw}kW peak)</span></td>
                                    <td class="px-2 py-1 text-right font-semibold">$${amberDemandCost.toFixed(2)}</td>
                                    <td class="px-2 py-1 text-right"></td>
                                </tr>`;
                hasDemandRow = true;
            }

            if (monthDemandInfo && monthDemandInfo.other && monthDemandInfo.other.cost > 0) {
                const maxDemandKw = (monthDemandInfo.other.maxDemandKwh * 2).toFixed(2);
                contentHtml += `<tr>
                                    <td class="px-2 py-1 text-sm" colspan="2">${planName} Demand Tariff <span class="font-normal text-gray-500 text-[10px]">(${maxDemandKw}kW peak)</span></td>
                                    <td class="px-2 py-1 text-right"></td>
                                    <td class="px-2 py-1 text-right font-semibold">$${otherDemandCost.toFixed(2)}</td>
                                </tr>`;
                hasDemandRow = true;
            }

            contentHtml += `<tr class="${hasDemandRow ? '' : 'border-t'}">
                                <td class="px-2 py-1 font-semibold" colspan="2">Daily Charges (${monthlySummary.daysInMonth} days)</td>
                                <td class="px-2 py-1 text-right font-semibold">$${totalAmberDailyCharges.toFixed(2)}</td>
                                <td class="px-2 py-1 text-right font-semibold">$${totalOtherDailyCharges.toFixed(2)}</td>
                            </tr>`;

            contentHtml += `<tr class="bg-gray-50 font-bold">
                                <td class="px-2 py-1" colspan="2">Total</td>
                                <td class="px-2 py-1 text-right">$${totalAmberCharges.toFixed(2)}</td>
                                <td class="px-2 py-1 text-right">$${totalOtherCharges.toFixed(2)}</td>
                            </tr>`;

            contentHtml += `</tbody></table>`;

            tooltip.innerHTML = contentHtml;
            positionTooltip(tooltip, element);
        }

        function hideTooltip() {
            const tooltip = document.getElementById('day-tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

    </script>
</body>
</html>
